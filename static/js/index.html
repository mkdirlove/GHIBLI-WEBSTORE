<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content=""><meta name="author" content=""><title>PisoFi</title><!-- Bootstrap core CSS --><link href="http://portal.pisofi.com/css/bootstrap-4.min.css" rel="stylesheet"><!-- Custom fonts for this template --><!-- Font Awesome 4.7.0 --><link rel="stylesheet" href="http://portal.pisofi.com/css/font-awesome.min.css"><link rel="stylesheet" href="http://portal.pisofi.com/plugins/simple-line-icons/css/simple-line-icons.css"><link href="http://portal.pisofi.com/css/alertify.min.css" rel="stylesheet"><link href="http://portal.pisofi.com/css/themes/boostrap.min.css" rel="stylesheet"><link rel="shortcut icon" type="image/ico" href="/custom.ico?version=20200301191900"/><style>
        footer {
            margin-top: 2em;
            position: relative;
        }

        @media (min-height: 60em) {
            footer {
                position: fixed;
                bottom: 0;
                width: 100%;
            }
        }

        .nomargin {
            margin: 0;
        }
        .nopadding {
            padding: 0;
        }
    </style><title>PisoFi | PisoFi</title><meta name="theme-color" content="#3c8dbc" /><link href="http://portal.pisofi.com/plugins/nos-form/nosform-jquery.min.css" rel="stylesheet" /><link href="http://portal.pisofi.com/plugins/datatables/dataTables.bootstrap4.min.css" rel="stylesheet"><style>
    /* GLOBAL STYLES
-------------------------------------------------- */
/* Padding below the footer and lighter body text */

body {
  color: #5a5a5a;
  background: url('/img/email-pattern.png');
}

.main-content {
    margin-top: 5em;
}

.progress{
    height:2.5rem;
    text-align:center;
    margin-bottom: .5rem;
}

.progress-bar {
    padding:18px;
    height: 100%;
}

.massive-font{
    font-size: 2rem;
}

.nomargin {
    margin: 0;
}

.pad {
    padding: 1rem;
}

.user-time {
    position: absolute;
    color: #000;
    font-size: .6em;
}
.pulse {
            border-radius: 50%;
            box-shadow: 0 0 0 rgba(204,169,44, 0.4);
            animation: pulse 1s infinite;
        }

 td.details-control {
            text-align:center;
            color:forestgreen;
    cursor: pointer;
}
tr.shown td.details-control {
    text-align:center; 
    color:red;
}

.js-promo-collapse {
    outline: none;
}
.js-promo-collapse {
    font-weight: bold;
}
.js-promo-collapse:after{
    content: "\02212";

}
.js-promo-collapse.collapsed {
    font-weight: normal;
}
.js-promo-collapse.collapsed:after {
    content: "\0002B";
}
.ajs-footer, .ajs-header {
    padding: .5em !important;
}

            #header {
            background: rgba(0,0,0,.2);
            text-shadow: 2px 2px 0 rgba(0,0,0,.3);
        }
        #header > a.navbar-brand {
        color: darkorange;
        text-shadow: 0 0 5px rgba(0,0,0,.5);
        font-weight: bold;
        -webkit-text-stroke: .6px #000;
        -moz-text-stroke: .6px #000;
    }

/* CUSTOMIZE THE CAROUSEL
-------------------------------------------------- */

/* Carousel base class */
.carousel {
  margin-top: -5em;
}
/* Since positioning the image, we need to help out the caption */
.carousel-caption {
  bottom: 3rem;
  z-index: 10;
  left: 0;
  right: 0;
  background: rgba(0,0,0,.2);
}
.carousel-caption p {
    margin: 0 !important;
}

/* Declare heights because of positioning of img element */
.carousel-item {
  background-color: #777;
}
.carousel-item > img {
  position: absolute;
  top: 0;
  left: 0;
  min-width: 100%;
  height: 32rem;
}

.connection-info {
    margin-top: 1em;
}


blockquote {
    display: block;
    border-width: 2px 0;
    border-style: solid;
    border-color: #eee;
    padding: .6em 0 0.2em 0;
    margin: 1em 0;
    position: relative;
    text-align: center;
}
blockquote:before {
    content: '\201C';
    position: absolute;
    top: 0em;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    width: 3rem;
    height: 2rem;
    font: 3em/1.08em 'PT Sans', sans-serif;
    color: #666;
    text-align: center;
}
blockquote:after {
    content: "\2013 \2003" attr(cite);
    display: block;
    text-align: right;
    font-size: 0.875em;
    color: #e74c3c;
}
/* RESPONSIVE CSS
-------------------------------------------------- */

@media (min-width: 40em) {
  /* Bump up size of carousel content */
  .carousel-caption p {
    margin-bottom: 1.25rem;
    font-size: 1.25rem;
    line-height: 1.4;
    text-stroke: 1px black;
    text-shadow:
    -1px -1px 0 #000,  
        1px -1px 0 #000,
        -1px 1px 0 #000,
        1px 1px 0 #000;
  }
}

#tbl-sessions {
    display: none;
}

.btn-group {
    margin: 0 auto;
    text-align: center;
    display: inline-block;
    width: inherit;
}

.slide {
    width: 100%;
    height: 300px;
    background-size: cover !important;
}

.connection-options {
    margin-bottom: 1rem;
}
@keyframes pulse {
	0% {
		transform: scale(0.95);
		box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7);
	}

	70% {
		transform: scale(1);
		box-shadow: 0 0 0 10px rgba(0, 0, 0, 0);
	}

	100% {
		transform: scale(0.95);
		box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
	}
}
    </style><link href="/css/custom.css?version=1623052214" rel="stylesheet" /><style>
        .site-name {
            font-size: 1em;
        }
    </style></head><body><!-- Site wrapper --><header><nav id="header" class="navbar navbar-dark fixed-top "><a class="navbar-brand site-name" href="http://portal.pisofi.com"><img src="http://portal.pisofi.com/img/custom.svg?version=20200301191900" width="30" height="30" style="background:#fff; box-shadow: 0 0 5px rgba(255,255,255,.8); border-radius: 25%;" class="d-inline-block align-top" alt="PisoFi Logo">
            PisoFi
        </a><button class="navbar-toggler bg-dark" type="button" data-toggle="collapse" data-target="#navMenus" aria-controls="navMenus" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon" style="height: 1em; width: 1em;"></span></button><div class="collapse navbar-collapse" id="navMenus"><div class="navbar-nav"><a class="nav-item nav-link text-white" href="/wipass"><i class="fa fa-fw fa-ticket"></i>WiPass</a></div></div></nav></header><!-- Content Wrapper. Contains page content --><main id="main-content" role="main"><!-- Main content --><section class="main-content nopadding"><div id="pisofi_banner" class="carousel slide" data-ride="carousel"><ol class="carousel-indicators"><li data-target="#pisofi_banner" data-slide-to="0"></li><li data-target="#pisofi_banner" data-slide-to="1"></li><li data-target="#pisofi_banner" data-slide-to="2"></li><li data-target="#pisofi_banner" data-slide-to="3"></li></ol><div class="carousel-inner"><div class="carousel-item active"><div class="slide" style="background: url('http://portal.pisofi.com/uploads/78615fd23bf0e5d8.jpg') no-repeat center;" alt=""></div></div><div class="carousel-item "><div class="slide" style="background: url('http://portal.pisofi.com/uploads/e0846714d6e36bd5.jpg') no-repeat center;" alt="Social Media"></div><div class="row"><div class="carousel-caption"><p>Social Media</p></div></div></div><div class="carousel-item "><div class="slide" style="background: url('http://portal.pisofi.com/uploads/94449d3ce6caebb1.jpg') no-repeat center;" alt="Browse the Internet"></div><div class="row"><div class="carousel-caption"><p>Browse the Internet</p></div></div></div><div class="carousel-item "><div class="slide" style="background: url('http://portal.pisofi.com/uploads/304457503361d4ac.png') no-repeat center;" alt="Play Online and Have Fun!"></div><div class="row"><div class="carousel-caption"><p>Play Online and Have Fun!</p></div></div></div></div><a class="carousel-control-prev" href="#pisofi_banner" role="button" data-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="sr-only">Previous</span></a><a class="carousel-control-next" href="#pisofi_banner" role="button" data-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span><span class="sr-only">Next</span></a></div><div class="container js-message-container"><div id="connection-notification" class="js-message"></div><div id="tagline" class="text-center text-dark font-weight-bold border-bottom border-top">
                    Discover the power of Piso!
                </div></div><div id="connection-info" style="position:relative;" class="container connection-info"><div id="available-coins" class="text-center mb-1"><span class="badge badge-primary badge-pill">Available Coins: 0.00</span></div><div id="device-info" class="text-center mb-1"><span class="device-mac-label">MAC: </span><span class="badge badge-pill device-mac">DC:F5:05:07:5E:59</span><span class="device-ip-label">IP: </span><span class="badge badge-pill device-ip">10.0.18.79</span></div><div id="progress-bar" class="progress"  style="position:relative;"><div class="progress-bar  progress-bar-striped progress-bar-animated js-progress" role="progressbar" aria-valuenow="5610" aria-valuemin="0" aria-valuemax="10500"></div><span style="width:100%; position:absolute; font-size: 2em;  line-height: 1.5em; color: #000; left:0; right:0;" class='js-progress-label progress-bar-label'></span></div><div id="connection-options" class="text-center connection-options"><div class="container text-center m-1" id="sessions-dropdown"><span class="session-message small">You have 1 Sessions</span><br><i class="fa fa-2x fa-fw text-info fa-chevron-circle-down js-toggle-sessions"></i></div><div id="tbl-sessions" class="table-responsive"><table class="table table-sm small"><thead><tr><th>Type</th><th>Time/Data</th><th>Speed</th><th>Status</th><th>Expiration</th><th></th></tr></thead><tbody></tbody></table></div><a id="btn-show-rates" style="cursor:pointer; position: relative;" class="badge btn-outline-secondary btn m-1 js-show-rates "><i class="fa fa-fw fa-wifi text-success"></i>
                                        WIFI RATES
                                                                            </a><div class="row" style="margin-bottom: 5px; margin-top: 1em;"><div id="button-options" class="col text-center"><span id="service-labels" class='badge badge-light border'><i class="fa fa-fw fa-arrow-circle-down"></i>
                                                        Wifi                                                                                                                | WiPass                                                    <i class="fa fa-fw fa-arrow-circle-down"></i></span><br><button id="btn-insert-coin" style="cursor: pointer; width: 250px;" class=" btn btn-lg bg-primary btn-primary js-insert-coin"><i class="fa fa-fw fa-money"></i> INSERT COIN <i class="fa fa-fw fa-money"></i></button><br><button id="btn-buy-eload" style="cursor: pointer; width: 250px;" class="btn btn-lg bg-info btn-info m-1 js-eload"><i class="fa fa-fw fa-mobile-phone fa-lg"></i> BUY E-LOAD <i class="fa fa-fw fa-mobile-phone fa-lg"></i></button><div class="btn-group"><button id="btn-use-wipass" style="cursor: pointer; width: 250px;" class="btn btn-lg bg-success btn-success js-use-wipass"><i class="fa fa-fw fa-ticket"></i> USE WIPASS <i class="fa fa-fw fa-ticket"></i></button></div></div></div></div><div class="text-center"></div></div><input type="hidden" name="csrf_name" value="csrf60bdcfb57253c" id="csrf_name"><input type="hidden" name="csrf_value" value="dabd843fd3f9f2dc8ea3cbc7e53beda5" id="csrf_value"><input type='hidden' id='mac' name='mac' value='DC:F5:05:07:5E:59' /><input type="hidden" id="ip" name="ip" value="10.0.18.79" /><input type="hidden" id="remaining" name="remaining" value="5610" /><input type="hidden" id="connection_time" name="connection_time" value="10500" /></section><!-- /.content --><div ref="chat" style="display: none;" id="pisofi-chat"><pfi-chat-manager
                :conversations="conversations"
                :chatid="chatid"
            ></pfi-chat-manager></div><footer><div class="container text-center"><p class='nomargin'>&copy; 2021 PisoFi. All Rights Reserved.</p></div></footer><!-- Bootstrap core JavaScript --><script src="http://portal.pisofi.com/js/jquery-3.2.1.min.js"></script><script src="http://portal.pisofi.com/js/alertify.min.js"></script><script src="http://portal.pisofi.com/js/bootstrap-4.min.js"></script><script src="http://portal.pisofi.com/js/vue.min.js" type="text/javascript"></script><script src="http://portal.pisofi.com/plugins/moment.js/moment2.11.2.min.js"></script><script src="http://portal.pisofi.com/js/when.min.js"></script><script src="http://portal.pisofi.com/js/autobahn.js"></script><script src="http://portal.pisofi.com/js/ifvisible.js"></script><!-- Plugin JavaScript --><!-- Custom scripts for this template --><script>
    $(function(){
        alertify.pop ||
            alertify.dialog('pop',
                function() {
                    return {
                        main: function(title, content) {
                            this.setHeader(title);
                            this.setContent(content);

                        },
                        build: function() {
                            $(this.elements.footer).hide();
                            var close = $(this.elements.commands.close);
                            setTimeout(function(){
                                close.show();
                            }, 1000);
                        },
                        setup: function() {
                            return {
                                focus: {
                                    element: function() {
                                        return this.elements.body.querySelector(this.get('selector'));
                                    },
                                    select: true
                                },
                                options: {
                                    maximizable: false,
                                    resizable: false,
                                    padding: false,
                                    movable: false,
                                    modal: true,
                                    closable: false
                                }
                            };
                        },
                        settings: {
                            selector: undefined
                        }
                    };
                });
        alertify.window ||
            alertify.dialog('window',
                function() {
                    return {
                        main: function(title, content) {
                            this.setHeader(title);
                            this.setContent(content);

                        },
                        build: function() {
                            $(this.elements.footer).hide();
                            var close = $(this.elements.commands.close);
                            setTimeout(function(){
                                close.show();
                            }, 1000);
                        },
                        setup: function() {
                            return {
                                focus: {
                                    element: function() {
                                        return this.elements.body.querySelector(this.get('selector'));
                                    },
                                    select: true
                                },
                                options: {
                                    maximizable: false,
                                    resizable: false,
                                    padding: false,
                                    movable: false,
                                    modal: true,
                                    closable: false
                                }
                            };
                        },
                        settings: {
                            selector: undefined
                        }
                    };
                });
        alertify.window2 ||
            alertify.dialog('window2',
                function() {
                    return {
                        main: function(title, content) {
                            this.setHeader(title);
                            this.setContent(content);

                        },
                        build: function() {
                            $(this.elements.footer).hide();
                            var close = $(this.elements.commands.close);
                            setTimeout(function(){
                                close.show();
                            }, 1000);
                        },
                        setup: function() {
                            return {
                                focus: {
                                    element: function() {
                                        return this.elements.body.querySelector(this.get('selector'));
                                    },
                                    select: true
                                },
                                options: {
                                    maximizable: false,
                                    resizable: false,
                                    padding: false,
                                    movable: false,
                                    modal: true,
                                    closable: false
                                }
                            };
                        },
                        settings: {
                            selector: undefined
                        }
                    };
                });

        function onElementHeightChange(elm, callback){
            var lastHeight = elm.innerHeight, newHeight;
    
            (function run(){
                newHeight = elm.innerHeight;
                if( lastHeight != newHeight )
                    callback(newHeight);
                lastHeight = newHeight;

                if( elm.onElementHeightChangeTimer )
                    clearTimeout(elm.onElementHeightChangeTimer);

                elm.onElementHeightChangeTimer = setTimeout(run, 200);
            })();
        }

        function onElementWidthChange(elm, callback){
            var lastWidth = elm.clientWidth, newWidth;
            (function run(){
                newWidth = elm.clientWidth;
                if( lastWidth != newWidth )
                    callback(newWidth);
                lastWidth = newWidth;

                if( elm.onElementHeightChangeTimer )
                    clearTimeout(elm.onElementHeightChangeTimer);

                elm.onElementHeightChangeTimer = setTimeout(run, 200);
            })();
        }

        var main = $(window),
            footer = $("footer"),
            banner = $("#pisofi_banner"),
            connectionInfo = $(".connection-info"),
            services = $("#services"),
            message = $(".js-message-container");


        onElementHeightChange(main.get(0),function(newHeight){
            repositionFooter(newHeight);
        });

        function repositionFooter(newHeight) {
            var allHeights = ((connectionInfo.height() || 0) + (services.height() || 0) + (message.height() || 0) + (banner.height() || 0)) + 100;
            if (newHeight > allHeights) {
                footer.css({
                    'width' : '100%',
                    'bottom' : '.3em',
                    'position' : 'fixed'
                });
            } else {
                footer.css({
                    'position': 'relative',
                    'margin-top': '2em',
                });
            }
        }

        setTimeout(function(){
            repositionFooter(main.get(0).innerHeight);
        }, 2000);

        function changeBannerHeight(newWidth) {
            if (newWidth > 450) {
                if (newWidth > 855) {
                    $(".slide").css("height",  "600px");
                } else {
                    $(".slide").css("height", (newWidth - 175 ) + "px");
                }
            } else {
                $(".slide").css("height",  "300px");
            }
        }

        if (banner.length) {
            onElementWidthChange(banner.get(0),function(newWidth){
                changeBannerHeight(newWidth);
            });
            changeBannerHeight(banner.width());
        }


    });
</script></body></html><script id="tpl-rates" type="text/x-handlebars-template">
        {{#if this.show_time_rates }}
            <div class="pad" style="padding-bottom: 0px;"><table class="small table table-sm" style="table-layout: fixed;"><h6 class = 'text-center'><strong>Time Rates</strong></h6><thead><tr><th>COIN</th><th>TIME</th><th>DESCRIPTION</th></tr></thead><tbody>
                        {{#each this.time_rates}}
                            <tr><td
                                    {{#if this.promo }}
                                        class="text-success font-weight-bold"
                                        style="font-size: 1.3em; white-space: nowrap; vertical-align: middle;"
                                    {{/if}}
                                >
                                    {{coin}}
                                </td><td
                                    {{#if this.promo }}
                                        class="text-success font-weight-bold"
                                        style="font-size: 1.3em; white-space: nowrap; vertical-align: middle;"
                                    {{/if}}
                                >{{time}}</td><td
                                
                                >
                                {{#if this.promo }}
                                    <h6 class="h6 font-weight-bold m-0"><i class="fa fa-star text-danger"></i>
                                        {{ name }}
                                    </h6><em class="small text-muted">Validity: {{  validity }}</em><br>
                                {{/if}}
                                {{description}}</td></tr>
                        {{/each}}
                    </tbody></table></div>
        {{/if}}


        {{#if this.show_data_rates }}
            <div class="m-0 pad"
                {{#if this.show_time_rates }}
                    style="padding-top: 0px;"
                {{/if}}
            ><table class="small table table-sm"  style="table-layout: fixed;"><thead><h6 class = 'text-center'><strong>Data Rates</strong></h6><tr><th>COIN</th><th>DATA</th><th>DESCRIPTION</th></tr></thead><tbody>
                        {{#each this.data_rates}}
                            <tr><td
                                    {{#if this.promo }}
                                        class="text-success font-weight-bold"
                                        style="font-size: 1.3em; white-space: nowrap; vertical-align: middle;"
                                    {{/if}}
                                >
                                    {{coin}}
                                </td><td
                                    {{#if this.promo }}
                                        class="text-success font-weight-bold"
                                        style="font-size: 1.3em; white-space: nowrap; vertical-align: middle;"
                                    {{/if}}
                                >{{data}}</td><td
                                
                                >
                                {{#if this.data_rates.promo }}
                                    <h6 class="h6 font-weight-bold m-0"><i class="fa fa-star text-danger"></i>
                                        {{ name }}
                                    </h6><em class="small text-muted">Validity: {{  validity }}</em><br>
                                {{/if}}
                                {{description}}</td></tr>
                        {{/each}}
                    </tbody></table></div>
        {{/if}}

        {{#if this.promo_packages }}
            <div class="text-center"><a href="/services" class="btn btn-block btn-warning"><span>Looking for more? Check out the </span><br><span class="font-weight-bold">Promos and Services</span><span class="pulse p-1"><span class="badge badge-success badge-pill">{{ this.promo_packages }}</span></span></a></div>
        {{/if}}
    </script><script id="tpl-rates-charging" type="text/x-handlebars-template"><div class="pad"><table class="small table table-sm" style="table-layout: fixed;"><thead><tr><th>COIN</th><th>TIME</th><th>DESCRIPTION</th></tr></thead><tbody>
                    {{#each this}}
                        <tr><td>{{coin}}</td><td>{{time}}</td><td>{{description}}</td></tr>
                    {{/each}}
                </tbody></table></div></script><script id="tpl-promos" type="text/x-handlebars-template"><div id=""><button class="btn btn-sm btn-block btn-primary mb-3 rounded-0 js-show-history"><i class="fa fa-eye"></i> Show Transacation History</button>
            {{#if this.options.allow_regular }}
                <h4>Regular Load</h4><div class="form-group"><div class="input-group mb-3"><input id="regular-load-input" type='number' class="form-control" placeholder="Enter load amount." /><div class="input-group-append"><button class="btn btn-info js-buy-regular-load" type="button">PAY</button></div></div></div>
            {{/if}}
        </div>
        {{#if this.options.allow_promos }}
            <div id="promos"><h4>Promos</h4>
                {{#each this.promos}}
                <div class="card rounded-0"><div class="card-header p-0" id="headingOne"><h5 class="mb-0"><button class="btn btn-link" data-toggle="collapse" data-target="#{{ this.network.code }}" aria-expanded="true" aria-controls="collapseOne">
                                {{ this.network.name }}
                            </button><button class="js-promo-collapse btn rounded-0 pull-right {{#unless ../show}}collapsed{{/unless}}" data-toggle="collapse" data-target="#{{ this.network.code }}" aria-expanded="true" aria-controls="collapseOne"></button></h5></div><div id="{{ this.network.code }}" class="collapse {{ ../show }} " aria-labelledby="headingOne" data-parent="#accordion"><div class="card-body"><table style="width: 100%;" class="table table-sm"><thead><tr><th></th><th>Name</th><th>Price</th><th>Description</th><th></th></tr></thead><tbody>
                                    {{#each this.promos}}
                                        <tr><td></td><td>{{ title }}</td><td>{{ price }}</td><td>{{ description }}</td><td><button data-network="{{ network }}" data-code="{{ @key }}" class="btn btn-sm btn-success rounded js-buy-load">BUY</button></td></tr>
                                    {{/each}}
                                </tbody></table></div></div></div>
                {{/each}}
                {{#unless all}}
                    <button class="btn btn-link js-show-all-promos">Show All Promos</button>
                {{/unless}}

            </div>
        {{/if}}
    </script><script id="tpl-promo" type="text/x-handlebars-template"><div class="pad js-payment-form"><table class="table table-sm small"><tr><td>Network</td><td>{{ network }}</td></tr><tr><td>Mobile Number</td><td>{{ mobile }}</td></tr><tr><td>Name</td><td>{{ title }}</td></tr><tr><td>Description</td><td>{{ description }}</td></tr><tr class=""><td class="font-weight-bold">PRICE</td><td class="text-right text-danger font-weight-bold h3">{{ price }}</td></tr><tr class=""><td class="font-weight-bold">WALLET</td><td id="coin-inserted" class="text-right font-weight-bold h3"><span id="wallet-balance">
                            {{ balance }}
                        </span></td></tr>
                {{#if walletEnough}}
                    <tr><td colspan="2" class="text-center"><button id="btn-pay-load-wallet" class="btn btn-success"><i class="fa fa-money"></i>
                                PAY using Wallet
                                <i class="fa fa-money"></i></button></td></tr>
                {{/if}}

                {{#if walletEnough}}
                {{else}}
                    <tr class=""><td class="font-weight-bold" style="white-space: nowrap;">COIN INSERTED</td><td class="text-right font-weight-bold h3"><span id="eload-coins"></span></td></tr>
                {{/if}}
            </table>

            {{#unless walletEnough}}

                <div class="border margin-bottom" style="box-shadow: 0 0 5px rgba(0,0,0,.4);"><div class="form-control"><label for="vendo">SELECT VENDO:</label><select id="vendo" class="form-control form-control-lg"><option value=""></option></select></div></div><div style='display:none;' class="js-payment"><div class="js-eload-insert-message text-center p-1"></div><div class="js-payment-controls"><div class="progress" ><div class="progress-bar" style="width:100%"></div></div></div></div><div class="text-center m-2"><button id="btn-pay-load" class="btn btn-success"><i class="fa fa-money"></i>
                        PAY
                        <i class="fa fa-money"></i></button></div>
                
            {{/unless}}
            
        </div></script><script id="tpl-vendos-option" type="text/x-handlebars-template"><option value=""></option>
        {{#each this}}
            <option value="{{ address }}">{{ name }}</option>
        {{/each}}
    </script><script id="tpl-history" type="text/x-handlebars-template"><div class="pad table-responsive"><table style="width: 100%;" class="table table-sm small table-striped"><thead><tr><th></th><th>Date</th><th>Ref #</th><th>Amount</th><th>Description</th></tr></thead><tbody>
                    {{#each this}}
                        <tr><td><button data-reference="{{ full_reference_number }}" class="btn btn-sm btn-success js-show-order"><i class="fa fa-eye"></i></button></td><td style='white-space: nowrap;'>{{ date }}</td><td>
                                {{ reference_number }}
                                {{#if refunded}}
                                    <span class="badge badge-pill badge-primary small">REFUNDED</span>
                                {{/if}}
                            </td><td>{{ amount }}</td><td style='white-space: nowrap;'>{{ description }}</td></tr>
                    {{/each}}
                </tbody></table></div></script><script id="tpl-order" type="text/x-handlebars-template"><div class="card pad"><ul class="list-group list-group-flush"><li class="list-group-item p-0"><span class="text-secondary small">REFERENCE #</span><br>
                    {{ reference_number }}
                </li><li class="list-group-item p-0"><span class="text-secondary small">PROMO</span><br>
                    {{ description }}
                </li><li class="list-group-item p-0"><span class="text-secondary small">PRICE</span><br>
                    {{ price }}
                </li></ul><div class="card-body text-center">
                {{#if refundable}}
                    <h3 class="text-success font-weight-bold">{{ price }}</h3><button data-reference="{{ full_reference_number }}" class="btn btn-sm btn-success js-claim-refund">CLAIM REFUND</button>
                {{else}}
                    {{#if refunded}}
                        <span class="text-primary">REFUNDED</span>
                    {{else}}
                        <span class="text-secondary">SUCCESS</span>
                    {{/if}}
                {{/if}}
                </div></div></script><script id="tpl-eload" type="text/x-handlebars-template"><div class="pad js-promo-dialog">
            {{#if networks}}
                <div class="network-status small">
                    {{#if last_check }}
                        <p class="h6">Last Check: <span class="badge badge-primary">{{ last_check }}</span></p>
                    {{/if}}
                    <table class="table table-sm mb-0"><thead><tr><th>Network</th><th>Status</th></tr></thead><tbody>
                            {{#each networks}}
                                <tr><td>{{ this.name }}</td><td>{{ this.status }}</td></tr>
                            {{/each}}
                        </tbody></table></div>
            {{/if}}
            <div class="form-group" style="margin-bottom: 0 !important;"><label for="mobile-number">Mobile Number:</label><div class="input-group" style="margin-bottom: 0 !important;"><input id="mobile-number" type='number' class="form-control" placeholder="Enter your 11-digit mobile number." /><div class="input-group-append"><button class="btn btn-info js-show-promo-list" type="button">OK</button></div></div></div><div class="js-promo-list"></div></div></script><script id="tpl-insert-coin" type="text/x-handlebars-template"><div class="text-center js-insert-container"><div  class="card shadow-sm"><div style="padding-top: 0; padding-bottom: 0;" class="card-body"><div style="display: none;" class="js-insert-body"><h3 class="font-weight-bold p-1 border-bottom">{{ vendo.name }}</h3><span class="text-secondary font-weight-light">{{ vendo.description }}</span><div class="js-insert-coin-message text-center p-1 alert-info"></div><div class="js-insert-notification"></div><div class="progress"><div style="white-space: nowrap;" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100" style="width: 100%;" aria-valuenow="100"></div></div></div><div class="js-insert-details"><h1 id="insert-coin-coins" class="card-title font-weight-bold js-insert-coin-coins">Loading...</h1><table style="display: none;" class="table table-sm text-left js-table-items"><thead><th>Item</th><th>Time</th><th>Action</th></thead><tbody><tr style="display: none;" class="js-row-wifi"><td class="small align-middle"><i class="text-success fa fa-wifi"></i> TIME</span></td><td class="align-middle"><span class="text-left badge badge-pill badge-info js-time-wifi">0</span><span title="Expiration" style="display:none !important;" id="time-option-expiration" class="text-left badge text-muted js-time-wifi-expiration">0</span></td><td class="align-middle"><button type="button" class="btn btn-sm btn-block btn-outline-success js-select-wifi"><span class="small"></span> GO ONLINE</button></td></tr><tr style="display: none;" class="js-row-data"><td class="small align-middle"><i class="text-success fa fa-dashboard"></i> DATA</span></td><td class="align-middle"><span class="text-left badge badge-pill badge-info js-time-data">0</span><span title="Expiration" style="display:none !important;" id="data-option-expiration" class="text-left badge text-muted js-time-data-expiration">0</span></td><td class="align-middle"><button type="button" class="btn btn-sm btn-block btn-outline-success js-select-data"><span class="small"></span> GO ONLINE</button></td></tr><tr style="display: none;" class="js-row-charge"><td class="small align-middle"><i class="text-warning fa fa-bolt"></i> CHARGE</span></td><td class="align-middle"><span class="badge badge-pill badge-info js-time-charge">0</span></td><td class="align-middle"><button type="button" class="btn btn-sm btn-block btn-outline-success js-select-charge"><span class="small"></span> CHARGE</button></td></tr><tr style="display: none;" class="js-row-wipass"><td class="small align-middle"><i class="text-primary fa fa-ticket"></i> WIPASS</span></td><td class="align-middle"><span class="badge badge-pill badge-info js-time-wipass">0</span><span title="Expiration" style="display:none !important;" id="wipass-option-expiration" class="text-left badge text-muted js-time-wifi-expiration">0</span></td><td class="align-middle"><button type="button" class="btn btn-sm btn-block btn-outline-success js-select-wipass"><span class="small"></span> CONVERT</button></td></tr></tbody></table></div><div class="insert-message"></div><div class="insert-footer"></div></div></div></div></script><script id="tpl-vendo-selection" type="text/x-handlebars-template"><section class="pad js-vendo-selection"><div class="row">
                {{#each this}}
                    <div class="col-sm-6 col-md-6 col-lg-6"><div class="card"><div class="card-body text-center p-0 border  bg-light"><button data-address="{{ address }}" class="btn btn-success btn-block btn-sm js-select-vendo-item"><h5 class="card-title p-1 m-0 border-bottom"><i class="fa fa-fw fa-server"></i>{{ name }}</h5></button>
                                {{#if description }}
                                    <small class="card-text">{{ description }}</small>
                                {{/if}}
                            </div></div></div>
                {{/each}}
            </div></section></script><script id="tpl-sessions" type="text/x-handlebars-template">
        {{#each this.sessions }}
            <tr 

                {{#if this.active  }}
                    class="text-success font-weight-bold"
                {{else}}
                    {{#if this.current }}
                        class="text-warning font-weight-bold"
                    {{/if}}
                {{/if}}
            ><td style="white-space: nowrap; vertical-align: middle;"><span class="session-type">{{ this.type_description }}</span> &rsaquo; <span class="session-category">{{ this.origin_description }}</span></td><td style="white-space: nowrap; vertical-align: middle;" class="js-session-{{ this.id }}">
                    {{#if this.is_data }}
                        {{ this.formatted_remaining_data }}
                    {{ else }}
                        {{ this.formatted_remaining_time }}
                    {{/if }}
                </td>
                {{#if this.show_speed}}
                    <td style="white-space: nowrap; vertical-align: middle;">{{ this.connection_speed }}</td>
                {{/if}}
                <td style="white-space: nowrap; vertical-align: middle;">{{ this.status_description }}</td><td style="white-space: nowrap; vertical-align: middle;">
                    {{#if this.expired }}
                        <span style="font-size: 1em;" class="badge badge-danger">EXPIRED</span>
                    {{else}} 
                        {{ this.expiration_date }} 
                    {{/if}}
                </td><td style="white-space: nowrap; vertical-align: middle;">
                    {{#if this.active  }}
                        {{#if this.is_pausable }}
                            <button title="Pause Connection" data-id="{{ this.id }}" class="btn btn-sm rounded-0 btn-outline-light bg-warning js-pause-session" ><i class="fa fa-fw fa-pause"></i></button>
                        {{/if }}
                    {{else}}
                        {{#if this.expired }}
                            <button title="Remove Connection" data-id="{{ this.id }}" class="btn btn-sm rounded-0 btn-outline-light bg-danger js-delete-session" ><i class="fa fa-fw fa-times"></i></button>
                        {{else}}
                            {{#if this.can_switch }}
                                <button title="Resume Connection" data-id="{{ this.id }}" class="btn btn-sm rounded-0 btn-outline-light bg-success js-resume-session" ><i class="fa fa-fw fa-play"></i></button>
                            {{/if }}
                        {{/if }}
                    {{/if }}
                    {{#if this.is_convertible }}
                        <button title="Convert to Wipass" data-id="{{ this.id }}" data-time="{{ this.remaining_time }}" class="btn btn-sm rounded-0 btn-outline-light bg-info js-convert-to-wipass"><i class="fa fa-fw fa-ticket text-primary"></i></button>
                    {{/if }}

                    {{#if this.active }}
                        {{#if this.is_transferrable }}
                            {{#if this.transfer_code }}
                                <span  title="Time Transfer Code" id="label-transfer-code" title="Transfer Code" class="btn bg-primary btn-sm rounded-0 btn-outline-light text-white">
                                    {{ this.transfer_code }} <i style='padding: 0 .5em;' class="fa fa-close text-danger js-cancel-transfer"></i></span>
                            {{ else }}
                                <button  title="Transfer Time" id="btn-transfer-time" style="cursor:pointer;" class="btn bg-primary btn-sm rounded-0 btn-outline-light js-transfer-time"><i class="fa fa-fw fa-share"></i></button>
                            {{/if }}
                        {{/if }}
                    {{/if }}
                </td></tr>
        {{/each}}
    </script><script src="http://portal.pisofi.com/plugins/datatables/jquery.dataTables-b4.min.js"></script><script src="http://portal.pisofi.com/plugins/datatables/dataTables.bootstrap4.min.js"></script><script src="http://portal.pisofi.com/js/easytimer.min.js"></script><script src="http://portal.pisofi.com/js/string.polyfill.min.js" type="text/javascript"></script><script src="http://portal.pisofi.com/plugins/nos-form/nosform-jquery.min.js" type="text/javascript"></script><script src="http://portal.pisofi.com/js/handlebars.min.js"></script><script src="http://portal.pisofi.com/js/pisofi.js"></script><script>
                $(function(){
                    alertify.set('notifier','position','top-center');

                    
                    
                function createAlertifyDialog(name) {
                        alertify[name] ||
                            alertify.dialog(name,
                                function() {
                                    return {
                                        main: function(title, content) {
                                            this.setHeader(title);
                                            this.setContent(content);

                                        },
                                        build: function() {
                                            $(this.elements.footer).hide();
                                            var close = $(this.elements.commands.close);
                                            setTimeout(function(){
                                                close.show();
                                            }, 700);
                                        },
                                        setup: function() {
                                            return {
                                                focus: {
                                                    element: function() {
                                                        return this.elements.body.querySelector(this.get('selector'));
                                                    },
                                                    select: true
                                                },
                                                options: {
                                                    maximizable: false,
                                                    resizable: false,
                                                    padding: false,
                                                    movable: false,
                                                    modal: true,
                                                    closable: false
                                                }
                                            };
                                        },
                                        settings: {
                                            selector: undefined
                                        }
                                    };
                                });
                }
                    
                var pfi = (function($, Timer, h, Pisofi){

                        function Field(type, name, title, options) {
                            this.type = type;
                            this.name = name;
                            this.title = title;
                            this.options = options;
                        };

                        Field.prototype.toField = function() {
                            var prop = {
                                "name": this.name,
                                "id": this.name + "-field",
                                "type": this.type,
                                "title": this.title,
                                "autofocus": true,
                                "label": this.title,
                                "placeholder": this.title,
                                "classname": "js-" + this.name
                            };
                            for (var key in this.options) {
                                prop[key] = this.options[key];
                            }
                            return prop;
                        };

                        Number.prototype.padStart = String.prototype.padStart;
                        Timer.prototype.toReadable = function() {
                            var t = this.getTimeValues();
                            return t.days.padStart(2,"0") + ":" + t.hours.padStart(2,"0") + ":" + t.minutes.padStart(2,"0") + ":" + t.seconds.padStart(2,"0");
                        };
                        Timer.prototype.toHumanReadable = function() {
                            var t = this.getTimeValues();
                            var timeMap = {
                                days : "d",
                                hours : "h",
                                minutes : "m",
                                seconds : "s"
                            };

                            var data = [],
                                keys = Object.keys(timeMap);

                            keys.forEach(function(k){
                                if (t[k] > 0) {
                                    data.push(t[k] + timeMap[k]);
                                }
                            });
                            if (data.length === 0) {
                                return "0";
                            }
                            if (data.length === 1) {
                                return data[0];
                            }
                            return data.splice(0,data.length-1).join(",") + " and " + data[0];

                        };
                        
                        String.prototype.toHHMMSS = function () {
                            var sec_num = parseInt(this, 10); // don't forget the second param
                            var hours   = Math.floor(sec_num / 3600);
                            var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
                            var seconds = sec_num - (hours * 3600) - (minutes * 60);

                            if (hours   < 10) {hours   = "0"+hours;}
                            if (minutes < 10) {minutes = "0"+minutes;}
                            if (seconds < 10) {seconds = "0"+seconds;}
                            return hours+'h:'+minutes+'m:'+seconds+"s";
                        }
                    var Pisofi = Pisofi || {};

                        Pisofi.remaining = 0;
                        Pisofi.connectionTime = 0;
                        Pisofi.csrf = { name : "", value : "" };
                        Pisofi.ip = null;
                        Pisofi.mac = null;
                        Pisofi.container = null;
                        
                    
                        Pisofi.coinInsertPlayer = new Audio("/assets/coin.wav");
                        Pisofi.successDing = new Audio("/assets/success_ding.wav");
                        Pisofi.insertPlayer = new Audio("/assets/b1.wav");
                        Pisofi.currentSession = null;
                        Pisofi.tblSessions = null;
                            Pisofi.btnInsertCoin = null;
                            Pisofi.insertCoinTimer = null;
                            Pisofi.insertCoinTransaction = {
                                vendo : null
                            };
                            Pisofi.insertCoinCoins = 0;
                            Pisofi.insertCoinRemainingTime = 0;
                            

                                                    Pisofi.promos = null;
                            Pisofi.eloadTimer = null;
                            Pisofi.btnShowPromos = null;
                            Pisofi.eloadCoins = 0;
                            Pisofi.loadTransaction = {
                                promo : null,
                                mobileNumber: null,
                                vendo: null,
                                subscribed : false,
                            };
                            
                        
                        Pisofi.btnUseWiPass = null;

                        
                        Pisofi.timer = null;
                        Pisofi.client = null;
                        Pisofi.connection = null;
                        Pisofi.labelMessage = null;
                        Pisofi.maxRetries = 10;
                        Pisofi.retries = 1;
                        Pisofi.isOnline = true;
                        Pisofi.minTimeWipassConversion = parseInt("60",0) || 0;
                        
                        Pisofi.loader = $("<div style='position:fixed; top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.7);z-index:99999;'><img style='top: 50%;left: 50%;position: fixed;margin-left: -64px;margin-top: -64px;' src='/img/cube.gif' /></div>").appendTo($("body")).hide();

                        Pisofi.templates = {};
                        Pisofi.compiledTemplates = {};

                        Pisofi.init = function(options){
                            Pisofi.container = options.container;
                            Pisofi.ip = options.ip;
                            Pisofi.mac = options.mac;
                            Pisofi.csrf.name = options.csrf.name;
                            Pisofi.csrf.value = options.csrf.value;
                            Pisofi.remaining = options.remaining;
                            Pisofi.connectionTime = options.connectionTime;
                            Pisofi.isConnected = false;

                                                            Pisofi.btnInsertCoin = Pisofi.container.find('.js-insert-coin');
                            
                                                            Pisofi.btnShowPromos = Pisofi.container.find('.js-show-promos');
                            
                            
                            Pisofi.tblSessions = Pisofi.container.find("#tbl-sessions");
                            Pisofi.btnUseWiPass = Pisofi.container.find('.js-use-wipass');
                            Pisofi.progress = Pisofi.container.find('.js-progress');
                            Pisofi.progressLabel = Pisofi.container.find('.js-progress-label');
                            Pisofi.labelMessage = Pisofi.container.find('.js-message').addClass('text-center');
                            Pisofi.timer = new Timer();
                            Pisofi.client = options.client;
                            Pisofi.currentSession = Pisofi.client ? Pisofi.container.find('.js-session-' + Pisofi.client.session_id) : null;
                            Pisofi.templates = options.templates;
                            Pisofi.loader.show();
                            Pisofi.connect();
                            Pisofi.compileTemplates();
                            Pisofi.bindEvents();
                            Pisofi.checkClient();

                            var expired = Pisofi.client && Pisofi.client.status === 4;

                            if (expired) {
                                alertify.confirm("Confirm","Your session has expired. Do you want to remove it?", function(){
                                    var formdata = {};
                                    formdata.csrf_name = Pisofi.csrf.name;
                                    formdata.csrf_value = Pisofi.csrf.value;
                                    formdata.id = Pisofi.client.session_id;
                                    Pisofi.removeThisSession(formdata)
                                        .always(function(response){
                                            alertify.success(response.result.message);
                                            setTimeout(function(){
                                                window.location.reload();
                                            }, 1000);
                                        })
                                }, function(){
                                            
                                    
                                    
                                                                    });
                            } else {

                                
                                
                                                            }

                        };

                        function getWsUrl() {
                            var ipformat = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
                            var url = window.location.hostname == "portal.pisofi.com" ? "10.0.0.1" : window.location.hostname;
                            var wsUrl = 'ws://'+url+'/ws';
                            if (url.match(ipformat)){
                                wsUrl = 'ws://' + url + ':8080';
                            }
                            return wsUrl;
                        }

                        Pisofi.connect = function(){
                            Pisofi.retries++;
                            Pisofi.labelMessage.html("<span class='text-success'><i class='fa fa-wifi text-success'></i></span>");
                            Pisofi.connection = new ab.Session('ws://10.0.0.1:8080', function() {
                                Pisofi.labelMessage.html("<span class='text-success'><i class='fa fa-wifi text-success'></i></span>");
                                Pisofi.retries = 0;
                                Pisofi.isConnected = true;
                                Pisofi.subscribe();
                                Pisofi.loader.hide();
                            }, function(){
                                Pisofi.loader.show();
                                if (Pisofi.retries >= Pisofi.maxRetries) {
                                    alert("Can't connect to Server.");
                                    window.location.reload();
                                    return;
                                }
                                Pisofi.labelMessage.html("<div class='alert alert-danger'>Connection Failed...Retrying...</div>").delay(1500).promise().then(function(){
                                    Pisofi.labelMessage.removeClass('alert-danger');
                                    Pisofi.connect();
                                });
                            });
                        }

                        Pisofi.compileTemplates = function() {
                            for (var k in Pisofi.templates) {
                                Pisofi.compiledTemplates[k] = h.compile(Pisofi.templates[k]);
                            }
                        }

                        Pisofi.subscribe = function() {
                            Pisofi.connection.subscribe("oninternetlost", Pisofi.onInternetLost);
                            Pisofi.connection.subscribe("oninternetok", Pisofi.onInternetOk);
                            Pisofi.connection.subscribe("oninsertcoinreset", Pisofi.onInsertCoinReset);
                                                            Pisofi.connection.subscribe("oneloadrefunded." + Pisofi.ip, Pisofi.onEloadRefunded);
                            
                            if (Pisofi.insertCoinTransaction && Pisofi.insertCoinTransaction.vendo) {
                                Pisofi.getInsertCoinSession();
                            }

                            if (Pisofi.loadTransaction && Pisofi.loadTransaction.vendo) {
                                Pisofi.getSession();
                            }

                        };

                        Pisofi.onInsertCoinReset = function(topic, data) {
                            if (Pisofi.insertCoinTransaction && Pisofi.insertCoinTransaction.vendo != null && Pisofi.insertCoinTransaction.vendo.toUpperCase() == data.vendo.toUpperCase()) {
                                alertify.closeAll();
                            }

                            if (Pisofi.loadTransaction && Pisofi.loadTransaction.vendo != null && Pisofi.loadTransaction.vendo.toUpperCase() == data.vendo.toUpperCase()) {
                                alertify.closeAll();
                            }
                        };

                        Pisofi.onInternetLost = function() {
                                                        Pisofi.labelMessage.html("<div class='text-danger alert alert-warning bg-warning' style='font-weight: bold;'><i class='fa fa-spinner fa-spin fa-fw'></i> No Internet Connection</span>");
                            if (Pisofi.isOnline) {
                                Pisofi.isOnline = false;
                            }
                            if (Pisofi.insertCoinTransaction) {
                                $(".js-insert-notification").html("<div class='text-danger alert alert-warning bg-warning' style='font-weight: bold;'><i class='fa fa-spinner fa-spin fa-fw'></i> No Internet Connection</span>");
                                $(".js-select-wifi, .js-select-data").hide();
                            }
                        };

                        Pisofi.onInternetOk = function() {
                                                        Pisofi.labelMessage.html("<span class='text-success'><i class='fa fa-wifi text-success'></i></span>");
                            if (!Pisofi.isOnline) {
                                Pisofi.isOnline = true;
                            }
                            if (Pisofi.insertCoinTransaction){
                                $(".js-insert-notification").html("");
                                $(".js-select-wifi, .js-select-data").show();
                            }
                        };

                        
                            
                            Pisofi.onEloadRefunded = function(topic,data){
                                if (Pisofi.ip == data.ip){
                                    alertify.closeAll();
                                    var msg = "<table class='table'><tr><th>AMOUNT</th><td>"+data.data.amount+"</td></tr><tr><th>DESCRIPTION</th><td>"+data.data.description+"</td></tr></table>";
                                    alertify.window("Eload Refund", "<div class='p-2'>"+data.message + "<hr>" + msg +"</div>")
                                }
                            };

                            Pisofi.getClientSession = function() {
                                var btnPay = $("#btn-pay-load");
                                Pisofi.connection.call("clientoldsession." + Pisofi.loadTransaction.vendo,{ vendo: Pisofi.loadTransaction.vendo, clientId : "" })
                                .then(function (data) {
                                            Pisofi.playBackgroundAudio();
                                            var eloadCoin = $("#eload-coins").html(data.amount.toFixed(2));
                                                eloadCoin.data('amount', data.amount);
                                            if (data.amount >= Pisofi.loadTransaction.promo.price){
                                                Pisofi.eloadCoins = data.amount;
                                                btnPay.removeAttr('disabled');
                                            } else {
                                                btnPay.attr('disabled','disabled');
                                            }
                                        },
                                        function (error) {
                                            // call failed
                                        });
                            }

                            Pisofi.showOrder = function() {
                                var $this = $(this),
                                    refNum = $this.data('reference');

                                $.ajax({
                                    type : 'GET',
                                    url : "/api/eload/order",
                                    dataType : 'json',
                                    data : {
                                        reference_number : refNum,
                                        csrf_name : Pisofi.csrf.name,
                                        csrf_value : Pisofi.csrf.value
                                    }
                                }).done(function(output){
                                    Pisofi.csrf.name = output.token.csrf_name;
                                    Pisofi.csrf.value = output.token.csrf_value;
                                    if (output.result.status == "OK") {
                                        var html = Pisofi.compiledTemplates.order(output.result.data);
                                        alertify.window2("Eload Transaction", html );
                                    }
                                    else {
                                        alertify.error(output.result.message);
                                    }
                                }).fail(function(){

                                });
                            };
                            Pisofi.claimRefund = function() {
                                var $this = $(this),
                                    refNum = $this.data('reference');

                                $.ajax({
                                    type : 'POST',
                                    url : "/api/eload/refundorder",
                                    dataType : 'json',
                                    data : {
                                        reference_number : refNum,
                                        csrf_name : Pisofi.csrf.name,
                                        csrf_value : Pisofi.csrf.value
                                    }
                                }).done(function(output){
                                    Pisofi.csrf.name = output.token.csrf_name;
                                    Pisofi.csrf.value = output.token.csrf_value;
                                    if (output.result.status == "OK") {
                                        alertify.closeAll();
                                        alertify.window("REFUND", "<div class='pad text-center'>" + output.result.message + "</div>");
                                    }
                                    else {
                                        alertify.warning(output.result.message);
                                    }
                                }).fail(function(){

                                });
                            };

                            Pisofi.onCoinInserted = function(topic,data){
                                if (Pisofi.ip == data.ip){
                                    Pisofi.eloadCoins = data.amount;
                                    var btnPay = $("#btn-pay-load");
                                    if (data.amount >= Pisofi.loadTransaction.promo.price){
                                        btnPay.removeAttr('disabled');
                                    } else {
                                        btnPay.attr('disabled','disabled');
                                    }
                                    
                                    $("#eload-coins").html(parseFloat(data.amount).toFixed(2));
                                    $('.js-payment-controls').find(".progress-bar").removeClass('bg-warning bg-danger');
                                    Pisofi.eloadRemainingTime = Pisofi.timeout;
                                    Pisofi.eloadTimer.reset();
                                    Pisofi.playInsertCoin();
                                    alertify.success("COIN INSERTED").dismissOthers();
                                }
                            };

                            Pisofi.getSession = function (){
                                Pisofi.connection.call('clientconnect.' + Pisofi.loadTransaction.vendo, { vendo: Pisofi.loadTransaction.vendo, clientId : "", eload: true })
                                    .then(function (result) {
                                        //console.log("Client Connect", result);
                                        try {
                                            Pisofi.connection.subscribe("oncoininserted." + Pisofi.loadTransaction.vendo, Pisofi.onCoinInserted);
                                        } catch (ex){

                                        }
                                        var lblEload = $(".js-eload-insert-message"),
                                            lblAmount = $("#eload-coins"),
                                            btnPay = $("#btn-pay-load"),
                                            paymentForm = $('.js-payment-form'),
                                            divPayment = paymentForm.find('.js-payment'),
                                            divPaymentDetails = paymentForm.find('.js-payment-controls');
                                        Pisofi.loadTransaction.subscribed = false;

                                        // call was successful
                                        if (result.status == "OK"){
                                            lblEload.removeClass('alert-danger h2').addClass('alert-info');
                                            Pisofi.timeout = result.data.time;
                                            Pisofi.loadTransaction.subscribed = true;
                                            Pisofi.eloadTimer = new Timer();

                                            Pisofi.eloadRemainingTime = Pisofi.timeout;
                                            var connectionTime = Pisofi.timeout,
                                                timeLabel = divPaymentDetails.find(".progress-bar").removeClass('bg-warning bg-danger');

                                            Pisofi.eloadTimer.start({countdown: true, startValues: {seconds: Pisofi.timeout }});
                                            timeLabel.html(Pisofi.eloadTimer.toHumanReadable());
                                            var percent = ((Pisofi.eloadRemainingTime/connectionTime)*100);
                                            Pisofi.eloadTimer.addEventListener('secondsUpdated', function (e) {
                                                if (!Pisofi.eloadTimer) {
                                                    e.detail.timer.stop();
                                                    return;
                                                }
                                                var percent = ((Pisofi.eloadRemainingTime/connectionTime)*100);
                                                timeLabel.css("width",percent + "%");
                                                if (percent > 30 && percent <= 70) {
                                                    if (!timeLabel.hasClass('bg-warning')){
                                                        timeLabel.removeClass('bg-primary').addClass('bg-warning');
                                                    }
                                                }
                                                if (percent <= 30) {
                                                    if (!timeLabel.hasClass('bg-danger')){
                                                        timeLabel.removeClass('bg-warning').addClass('bg-danger');
                                                    }
                                                }
                                                Pisofi.eloadRemainingTime--;
                                                timeLabel.html(Pisofi.eloadTimer.toHumanReadable());
                                            });
                                            Pisofi.eloadTimer.addEventListener('targetAchieved', function (e) {
                                                Pisofi.eloadTimer.stop();
                                                $("#vendo").val("").trigger("change");
                                            });

                                            lblEload.html(result.message);
                                            if ( Pisofi.eloadCoins >= Pisofi.loadTransaction.promo.price){
                                                btnPay.removeAttr('disabled');
                                            } else {
                                                btnPay.attr('disabled','disabled');
                                            }

                                            Pisofi.insertCoinTransaction.can_convert = result.data.can_convert;
                                            Pisofi.insertCoinTransaction.can_charge = result.data.can_charge;
                                            Pisofi.insertCoinTransaction.min_amount_for_wifi = result.data.min_amount_for_wifi;
                                            Pisofi.insertCoinTransaction.min_amount_for_data = result.data.min_amount_for_data;
                                            Pisofi.insertCoinTransaction.min_amount_for_wipass = result.data.min_amount_for_wipass;
                                            Pisofi.insertCoinTransaction.ask_confirmation = result.data.ask_confirmation;
                                            Pisofi.insertCoinTransaction.allow_audio = result.data.allow_audio;
                                            Pisofi.insertCoinTransaction.show_instructions = result.data.show_instructions;
                                            Pisofi.insertCoinTransaction.go_online_when_timeout = result.data.go_online_when_timeout;
                                            Pisofi.insertCoinTransaction.time_show_goonline = result.data.time_show_goonline;
                                            Pisofi.insertCoinTransaction.max_users_reached = result.data.max_users_reached;
                                            Pisofi.insertCoinTransaction.whitelisted = result.data.whitelisted;
                                            Pisofi.insertCoinTransaction.data_enabled = result.data.data_enabled;

                                            if (Pisofi.insertCoinTransaction.allow_audio) {
                                                Pisofi.playBackgroundAudio();
                                            }
                                            
                                            divPaymentDetails.show();
                                            divPayment.slideDown();
                                            Pisofi.playBackgroundAudio();

                                        } else {
                                            Pisofi.loadTransaction.subsribed = false;
                                            lblEload.removeClass('alert-info').removeClass('alert-info').addClass('alert-danger h2');
                                            lblEload.html(result.message);
                                            btnPay.attr('disabled','disabled');
                                            divPaymentDetails.hide();
                                            divPayment.slideDown();
                                        }
                                    },
                                    function (error) {
                                        // call failed
                                    });
                            }

                            function format ( d ) {
                                // `d` is the original data object for the row
                                return '<table class="table table-sm small">'+
                                    '<tr>'+
                                        '<td colspan="2">'+d[3]+'</td>'+
                                    '</tr>'+
                                '</table>';
                            }

                            Pisofi.showEloadDialog = function(evt){
                                                                    Pisofi.fnShowEloadDialog.call(this, evt);
                                                            };


                            Pisofi.fnShowEloadDialog = function() {
                                Pisofi.enableAudio();

                                $.getJSON("/api/eload/networkstatus").done(function(res){
                                    Pisofi.csrf.name = res.token.csrf_name;
                                    Pisofi.csrf.value = res.token.csrf_value;

                                    var eloadHtml = Pisofi.compiledTemplates.eload({ networks: res.result.data.networks, last_check: res.result.data.last_check });
                                    alertify.pop("PisoFi Eload", eloadHtml).set('selector', '#mobile-number');
                                    $("#mobile-number").on("keypress", function(e) {
                                        if (e.which === 13) {
                                            $(".js-show-promo-list").trigger('click');
                                        }
                                    });
                                    $("#mobile-number").val(Pisofi.loadTransaction.mobileNumber);
                                }).fail(function(err){
                                    alertify.warning("Failed to retrieve network status");
                                });

                                
                            };

                            Pisofi.payLoad = function() {
                                var transaction = Pisofi.loadTransaction;
                                if (Pisofi.eloadCoins < transaction.promo.price ) {
                                    alertify.warning("Insufficient amount. Please insert coin to avail this promo");
                                    return;
                                }

                                $.ajax({
                                    url: "/api/eload/buy",
                                    type: 'POST',
                                    dataType: 'json',
                                    data : {
                                        "csrf_name" : Pisofi.csrf.name,
                                        "csrf_value" : Pisofi.csrf.value,
                                        code : Pisofi.loadTransaction.promo.id,
                                        number : Pisofi.loadTransaction.mobileNumber,
                                        type: "coins",
                                        load_type: Pisofi.loadTransaction.loadType,
                                        amount : Pisofi.loadTransaction.amount,
                                        vendo : Pisofi.loadTransaction.vendo
                                    }
                                }).done(function(response){
                                    Pisofi.csrf.name = response.token.csrf_name;
                                    Pisofi.csrf.value = response.token.csrf_value;
                                    if (response.result.status == "OK") {
                                        alertify.closeAll();
                                        Pisofi.playSuccessDing();
                                        alertify.pop("Eload Confirmation", "<div class='pad text-center'>" + response.result.message + "</div>");
                                        Pisofi.loadTransaction = {
                                            promo : null,
                                            mobileNumber: null,
                                            vendo: null,
                                            subscribed : false,
                                        };
                                    } else {
                                        alertify.warning(response.result.message);
                                    }
                                }).fail(function(err){
                                    alertify.error("Something went wrong. Please refresh the page and try again.");

                                });




                            };
                        
                        Pisofi.payLoadWallet = function() {

                                $.ajax({
                                    url: "/api/eload/buy",
                                    type: 'POST',
                                    dataType: 'json',
                                    data : {
                                        "csrf_name" : Pisofi.csrf.name,
                                        "csrf_value" : Pisofi.csrf.value,
                                        code : Pisofi.loadTransaction.promo.id,
                                        number : Pisofi.loadTransaction.mobileNumber,
                                        type: "wallet",
                                        load_type: Pisofi.loadTransaction.loadType,
                                        amount : Pisofi.loadTransaction.amount,
                                        vendo : Pisofi.loadTransaction.vendo
                                    }
                                }).done(function(response){
                                    Pisofi.csrf.name = response.token.csrf_name;
                                    Pisofi.csrf.value = response.token.csrf_value;
                                    if (response.result.status == "OK") {
                                        alertify.closeAll();
                                        Pisofi.playSuccessDing();
                                        alertify.pop("Eload Confirmation", "<div class='pad text-center'>" + response.result.message + "</div>");
                                        Pisofi.loadTransaction = {
                                            promo : null,
                                            mobileNumber: null,
                                            vendo: null,
                                            subscribed : false,
                                        };
                                    } else {
                                        alertify.warning(response.result.message);
                                    }
                                }).fail(function(err){
                                    alertify.error("Something went wrong. Please refresh the page and try again.");
                                });
                            };

                            
                        
                            Pisofi.showEloadPromos = function(evt) {
                                var $this = $(this),
                                    txtMobile = $("#mobile-number"),
                                    mobileNumber = txtMobile.val(),
                                    eloadDialog = $this.closest('.js-promo-dialog'),
                                    promoList = eloadDialog.find('.js-promo-list'),
                                    mobilePattern = /^(\+63|0)?(9|8|7)\d{9}$/;

                                    if ($this.data('action') == 'edit') {
                                        txtMobile.removeAttr('readonly');
                                        $this.removeClass('btn-success')
                                            .data('action', 'set-number')
                                            .html("OK");

                                        Pisofi.loadTransaction.mobileNumber = null;
                                        promoList.html("");

                                    } else {
                                        if (!mobilePattern.test(mobileNumber)) {
                                            alertify.warning("Invalid Mobile Number");
                                            txtMobile.select();
                                            txtMobile.addClass('is-invalid text-danger');
                                            return;
                                        } else {
                                            txtMobile.removeClass('is-invalid text-danger');
                                        }

                                        txtMobile.attr('readonly','readonly');
                                        
                                        $this.addClass('btn-success')
                                            .data('action','edit')
                                            .html("<i class='fa fa-pencil'></i>");

                                        Pisofi.loadTransaction.mobileNumber = mobileNumber;

                                        Pisofi.getPromos(mobileNumber).done(function(response){
                                            var networks = response.result.networks;
                                            if (networks.length === 0) {
                                                alertify.warning("We are unable to determine your mobile number's network. Please make sure you have entered the correct number or inform the owner about your number");
                                                return;
                                            }

                                            if (networks.length > 1) {

                                                var fields = [];
                                                var options = {};
                                                networks.forEach(function(n) {
                                                    options[n] = n.toUpperCase();
                                                });

                                                fields.push(new Field("radio","network","Networks", { "options": options }).toField());
                                                                        
                                                var dialog = alertify.window('Choose Mobile Network',
                                                    "<div class='pad js-window-prefix small'></div>").show();

                                                var html = $(".js-window-prefix");
                                                var form = $("<form id='frm-reset'>");
                                                html.append(form);

                                                fields.push(new Field("submit", "submit", "Select", { required: true, inline: false, formGroup:true, value: "Select", classname: "btn btn-success pull-right" }).toField());

                                                form.nosForm({
                                                    fields: fields,
                                                    animationSpeed: 50,
                                                    validate: true,
                                                    ajax: true,
                                                    htmlValidation: false,
                                                    honeypot: true,
                                                    messageLocation: {
                                                        top: false,
                                                        bottom: true
                                                    },
                                                    submit: function (formdata, form, evt) {
                                                        if (!formdata.network) {
                                                            alertify.warning("Please select a network");
                                                            return;
                                                        }
                                                        Pisofi.loadTransaction.network = formdata.network;
                                                        Pisofi.loadTransaction.loadRanges = response.result.load_ranges;
                                                        if (response.result.status == "OK") {
                                                            dialog.close();
                                                            var promo = {};
                                                            promo[Pisofi.loadTransaction.network] = response.result.promos[Pisofi.loadTransaction.network];
                                                            Pisofi.promos = promo;
                                                            Pisofi.displayPromos(promoList, false, {
                                                                allow_promos : response.result.allow_promos,
                                                                allow_regular : response.result.allow_regular
                                                            });
                                                        }
                                                    },
                                                    init: function (form) {
                                                    },
                                                    onlySubmitWithValue: true
                                                });
                                            } else {
                                                if (!response.result.networks) {
                                                    alertify.warning("The system could not determine your mobile number network. Please try again.");
                                                } else {

                                                    Pisofi.loadTransaction.network = response.result.networks.shift();
                                                    Pisofi.loadTransaction.loadRanges = response.result.load_ranges;
                                                    if (response.result.status == "OK") {
                                                        var promo = {};
                                                        promo[Pisofi.loadTransaction.network] = response.result.promos[Pisofi.loadTransaction.network];
                                                        Pisofi.promos = promo;
                                                        Pisofi.displayPromos(promoList, false, {
                                                            allow_promos : response.result.allow_promos,
                                                            allow_regular : response.result.allow_regular
                                                        });
                                                    }
                                                }
                                            }
                                        })
                                        .fail(function(){

                                        });
                                    }
                                
                                evt.preventDefault();
                                return false;
                            };

                            Pisofi.getPromos = function(mobileNumber)
                            {
                                return $.ajax({
                                        type : 'GET',
                                        dataType : 'json',
                                        url: "/api/eload/promos",
                                        data : {
                                            number : mobileNumber
                                        }
                                    });
                            };

                            Pisofi.showAllPromos = function() {
                                Pisofi.getPromos().done(function(response){
                                        if (response.result.status == "OK") {
                                            Pisofi.csrf.name = response.token.csrf_name;
                                            Pisofi.csrf.value = response.token.csrf_value;
                                            Pisofi.promos = response.result.promos;
                                            Pisofi.displayPromos($('.js-promo-list'), true, {
                                                allow_promos : response.result.allow_promos,
                                                allow_regular : response.result.allow_regular
                                            });
                                        }
                                    })
                                    .fail(function(){

                                    });
                            };

                            Pisofi.showEloadHistory = function() {

                                $.ajax({
                                        type : 'GET',
                                        dataType : 'json',
                                        url: "/api/eload/history",
                                        data : {
                                            number : Pisofi.loadTransaction.mobileNumber
                                        }
                                    }).done(function(response){
                                        if (response.result.status == "OK") {
                                            Pisofi.csrf.name = response.token.csrf_name;
                                            Pisofi.csrf.value = response.token.csrf_value;
                                            var html = Pisofi.compiledTemplates.history(response.result.history);
                                            alertify.window("Eload History", html );
                                        }
                                    })
                                    .fail(function(){

                                    });
                            };

                            Pisofi.selectVendo = function() {
                                var $this = $(this),
                                    vendo = $this.val(),
                                    divPayment = $this.closest('.js-payment-form').find('.js-payment');
                                    divPayment.slideUp();
                                Pisofi.stopBackgroundAudio();
                                if (vendo.trim().length > 0 ) {
                                    if (Pisofi.loadTransaction.vendo && Pisofi.loadTransaction.subscribed) {
                                        try {
                                            Pisofi.connection.unsubscribe("oncoininserted." + Pisofi.loadTransaction.vendo, Pisofi.onCoinInserted);
                                        } catch (ex) {}
                                        if (Pisofi.eloadTimer) {
                                            Pisofi.eloadTimer.stop();
                                            Pisofi.eloadTimer = null;
                                        }
                                        Pisofi.loadTransaction.vendo = null;
                                    }

                                    Pisofi.loadTransaction.vendo = vendo;
                                    Pisofi.getSession();
                                } else {
                                    if (Pisofi.loadTransaction.vendo && Pisofi.loadTransaction.subscribed) {
                                        try {
                                            Pisofi.connection.unsubscribe("oncoininserted." + Pisofi.loadTransaction.vendo, Pisofi.onCoinInserted);
                                        } catch (ex) {}
                                        if (Pisofi.eloadTimer) {
                                            Pisofi.eloadTimer.stop();
                                            Pisofi.eloadTimer = null;
                                        }
                                    }
                                    Pisofi.loadTransaction.vendo = null;
                                    Pisofi.loadTransaction.subscribed = false;
                                }
                            };

                            

                            Pisofi.displayPromos = function(container, all, options) {
                                var promos = {
                                    promos : Pisofi.promos,
                                    all: all,
                                    options : {
                                        allow_promos : options.allow_promos,
                                        allow_regular : options.allow_regular
                                    }
                                };


                                if (Object.keys(promos.promos).length == 1) {
                                    promos.show = "show";
                                }
                                var html = Pisofi.compiledTemplates.promos(promos);
                                container.html(html).slideDown();
                                setTimeout(function(){
                                    var table = Pisofi.container.closest('body').find('#promos .table').DataTable({ 
                                        paging: false, 
                                        info: false,
                                        "columns": [
                                            {
                                                "className": 'details-control',
                                                "orderable": false,
                                                "data": null,
                                                "defaultContent": '',
                                                "render": function () {
                                                    return '<i class="fa fa-plus-square" aria-hidden="true"></i>';
                                                },
                                                width:"15px"
                                            },
                                            {   },
                                            {   },
                                            { visible: false },
                                            { orderable: false },
                                        ],
                                        "order": [[ 1, 'asc' ]]
                                    });

                                    $('#promos').on('click', 'td.details-control', function () {
                                        var tr = $(this).closest('tr');
                                        var tdi = tr.find("i.fa");
                                        var row = table.row(tr);

                                        if (row.child.isShown()) {
                                            // This row is already open - close it
                                            row.child.hide();
                                            tr.removeClass('shown');
                                            tdi.first().removeClass('fa-minus-square');
                                            tdi.first().addClass('fa-plus-square');
                                        }
                                        else {
                                            // Open this row
                                            row.child(format(row.data())).show();
                                            tr.addClass('shown');
                                            tdi.first().removeClass('fa-plus-square');
                                            tdi.first().addClass('fa-minus-square');
                                        }
                                    });
                                }, 200);
                            }


                            alertify.pay ||
                            alertify.dialog('pay',
                                function() {
                                    return {
                                        main: function(title, content) {
                                            this.setHeader(title);
                                            this.setContent(content);

                                        },
                                        build: function() {
                                                                                    },
                                        callback:function(closeEvent){
                                            //The closeEvent has the following properties
                                            //
                                            // index: The index of the button triggering the event.
                                            // button: The button definition object.
                                            // cancel: When set true, prevent the dialog from closing.
                                            if (confirm("Are you sure?")){
                                            } else {
                                                closeEvent.cancel = true;
                                            }
                                        },
                                        setup: function() {
                                            return {
                                                focus: {
                                                    element: function() {
                                                        return this.elements.body.querySelector(this.get('selector'));
                                                    },
                                                    select: true
                                                },
                                                buttons:[{text: "Cancel", className: "btn btn-secondary", key:27/*Esc*/}],
                                                options: {
                                                    maximizable: false,
                                                    resizable: false,
                                                    padding: false,
                                                    movable: false,
                                                    modal: true,
                                                    closable: false,
                                                    onshow: function() {
                                                        Pisofi.getClientSession();
                                                        window.onbeforeunload = function(){
                                                            return 'Are you sure you want to leave?';
                                                        };
                                                    },
                                                    onclose: function() {
                                                        try {
                                                            Pisofi.stopBackgroundAudio();
                                                            if (Pisofi.loadTransaction.vendo) {
                                                                Pisofi.connection.unsubscribe("oncoininserted." + Pisofi.loadTransaction.vendo, Pisofi.onCoinInserted);
                                                            }
                                                        } catch (ex) {}
                                                        if (Pisofi.eloadTimer) {
                                                            Pisofi.eloadTimer.stop();
                                                            Pisofi.eloadTimer = null;
                                                        }
                                                        Pisofi.loadTransaction.vendo = null;
                                                        window.onbeforeunload = function(){
                                                        };
                                                    }   
                                                }
                                            };
                                        },
                                        settings: {
                                            selector: undefined
                                        }
                                    };
                                });

                            Pisofi.buyLoad = function(evt) {
                                var $this = $(this),
                                    network = $this.data('network'),
                                    code = $this.data('code');
                                    
                                    var selNetwork = network in Pisofi.promos ? Pisofi.promos[network] : null;
                                    if (!selNetwork) {
                                        alertify.error("Network could not be found. Please reload this page.");
                                        return;
                                    }
                                    var selPromo = code in selNetwork.promos ? selNetwork.promos[code] : null;
                                    if (!selPromo) {
                                        alertify.error("Promo could not be found. Please reload this page.");
                                        return;
                                    }

                                    Pisofi.loadTransaction.promo = selPromo;
                                    Pisofi.loadTransaction.promo.id = code;
                                    Pisofi.loadTransaction.amount = selPromo.price;
                                    Pisofi.loadTransaction.loadType = "promo";

                                    $.ajax({
                                        url: "/api/eload/canbuy",
                                        type: 'POST',
                                        dataType: 'json',
                                        data : {
                                            "csrf_name" : Pisofi.csrf.name,
                                            "csrf_value" : Pisofi.csrf.value,
                                            code : code
                                        }
                                    }).done(function(response){
                                        Pisofi.csrf.name = response.token.csrf_name;
                                        Pisofi.csrf.value = response.token.csrf_value;

                                        if (response.result.status == "OK") {
                                            
                                            var walletBalance = parseFloat(response.result.data.balance,10),
                                                promoPrice = parseFloat(selPromo.price);
                                                
                                            var data = {
                                                title : selPromo.title,
                                                price: promoPrice.toFixed(2),
                                                description: selPromo.description,
                                                network: selNetwork.network.name,
                                                balance : walletBalance,
                                                mobile: Pisofi.loadTransaction.mobileNumber,
                                                walletEnough : (walletBalance >= promoPrice)
                                            };
                                            var html = Pisofi.compiledTemplates.promo(data);
                                            alertify.pay("Pay Load", html);

                                            $.getJSON("/api/vendos/active")
                                                .done(function(response){
                                                    var options = Pisofi.compiledTemplates.vendoOptions(response.result.data);
                                                    $("#vendo").html(options);
                                                    if (response.result.data.length == 1) {
                                                        $("#vendo").prop("selectedIndex",1).change();
                                                    } else {
                                                        $("#vendo").prop("selectedIndex",0).change();
                                                    }
                                                })
                                                .fail(function(fail){

                                                });
                                        } else {
                                            alertify.warning(response.result.message);
                                        }
                                    }).fail(function(err){

                                    });
                            };

                            function RegularLoadValidator(amount, rules){
                                this.amount = amount;
                                this.rules = rules;

                                this.isValid = function() {
                                    var self = this;
                                    for (var i=0;i<this.rules.length;i++) {
                                        var rule = this.rules[i];
                                         if (Array.isArray(rule)) {
                                            if (self.amount >= rule[0] && self.amount <= rule[1]) {
                                                return true;
                                            }
                                        } else {
                                            if (self.amount == rule) {
                                                return true;
                                            }
                                        }
                                    }
                                    return false;
                                };

                                this.getMessage = function() {
                                    var rules = [];
                                    this.rules.forEach(function(rule){
                                        if (Array.isArray(rule)) {
                                            rules.push("(" + rule.join("-") + ")");
                                        } else {
                                            rules.push(rule);
                                        }
                                    });
                                    return "Load Amount must be one of the following: " + rules.join(", ");
                                };
                            }

                            Pisofi.buyRegularLoad = function(evt) {
                                var $this = $(this),
                                    regularLoad = parseInt($("#regular-load-input").val(),10);

                                    var network = Pisofi.loadTransaction.network;
                                    var loadRanges = Pisofi.loadTransaction.loadRanges;

                                    var rules = loadRanges[network];
                                    var validator = new RegularLoadValidator(regularLoad, rules);
                                    if (!validator.isValid()) {
                                        alertify.warning(validator.getMessage());
                                        return;
                                    }
                                    
                                    $.ajax({
                                        url: "/api/eload/canbuy",
                                        type: 'POST',
                                        dataType: 'json',
                                        data : {
                                            "csrf_name" : Pisofi.csrf.name,
                                            "csrf_value" : Pisofi.csrf.value,
                                            type : "regular",
                                            amount : regularLoad,
                                            network: Pisofi.loadTransaction.network
                                        }
                                    }).done(function(response){
                                        Pisofi.csrf.name = response.token.csrf_name;
                                        Pisofi.csrf.value = response.token.csrf_value;

                                        if (response.result.status == "OK") {
                                            var walletBalance = parseFloat(response.result.data.balance,10),
                                                topup = parseFloat(response.result.data.topup, 10),
                                                promoPrice = regularLoad;
                                            if (!Pisofi.loadTransaction.promo) {
                                                Pisofi.loadTransaction.promo = {};
                                            }
                                            Pisofi.loadTransaction.promo.price = (promoPrice + topup);
                                            Pisofi.loadTransaction.amount = (promoPrice);
                                            Pisofi.loadTransaction.loadType = "regular";
                                            var data = {
                                                title : "Regular Load " + promoPrice,
                                                price: (topup + promoPrice).toFixed(2),
                                                description: "Regular Load: PHP" + promoPrice.toFixed(),
                                                code: "REG" + promoPrice,
                                                network: Pisofi.loadTransaction.network.toUpperCase(),
                                                balance : walletBalance,
                                                mobile: Pisofi.loadTransaction.mobileNumber,
                                                walletEnough : (walletBalance >= (promoPrice + topup))
                                            };
                                            var html = Pisofi.compiledTemplates.promo(data);
                                            alertify.pay("Pay Load", html);

                                            $.getJSON("/api/vendos/active")
                                                .done(function(response){
                                                    var options = Pisofi.compiledTemplates.vendoOptions(response.result.data);
                                                    $("#vendo").html(options);
                                                    if (response.result.data.length == 1) {
                                                        $("#vendo").prop("selectedIndex",1).change();
                                                    } else {
                                                        $("#vendo").prop("selectedIndex",0).change();
                                                    }
                                                })
                                                .fail(function(fail){

                                                });
                                        } else {
                                            alertify.warning(response.result.message);
                                        }
                                    }).fail(function(err){

                                    });

                            };

                        
                        Pisofi.runChargeTimer = function(){

                                                    };

                        Pisofi.checkClient = function(){
                            
                            if (!Pisofi.client || Pisofi.client.status == 1){
                                Pisofi.timer.start({countdown: true, startValues: {seconds: Pisofi.remaining}});
                                Pisofi.progressLabel.html(Pisofi.timer.toHumanReadable());
                                var percent = ((Pisofi.remaining/Pisofi.connectionTime)*100);
                                Pisofi.progress.css('width', percent + "%");
                                Pisofi.timer.addEventListener('secondsUpdated', function (e) {
                                    var percent = ((Pisofi.remaining/Pisofi.connectionTime)*100);
                                    if (percent > 30 && percent <= 70) {
                                        if (!Pisofi.progress.hasClass('bg-warning')){
                                            Pisofi.progress.removeClass('bg-primary').addClass('bg-warning');
                                        }
                                    }
                                    if (percent <= 30) {
                                        if (!Pisofi.progress.hasClass('bg-danger')){
                                            Pisofi.progress.removeClass('bg-warning').addClass('bg-danger');
                                        }
                                    }
                                    Pisofi.progress.css('width', percent + "%");
                                    Pisofi.remaining--;
                                    Pisofi.progressLabel.html(Pisofi.timer.toHumanReadable());
                                    if (Pisofi.client) {
                                        $('.js-session-' + Pisofi.client.session_id ).html(Pisofi.timer.toHumanReadable());
                                    }

                                                                    });
                                Pisofi.timer.addEventListener('targetAchieved', function (e) {
                                    alert("Your time is up\n\nThank you for using PisoFi");
                                    window.location.reload();
                                });
                            } else if (Pisofi.client.status == 2) {
                                    Pisofi.timer.start({countdown: true, startValues: {seconds: Pisofi.remaining}});
                                    var percent = ((Pisofi.remaining/Pisofi.connectionTime)*100);
                                    Pisofi.progress.css('width', percent + "%");
                                    Pisofi.progressLabel.html(Pisofi.timer.toHumanReadable());
                                    Pisofi.timer.stop();
                            }
                        }

                        Pisofi.bindEvents = function(){

                            Pisofi.fn.keepAlive.call(this, 30);
                            ifvisible.on("blur", function(){
                                alertify.closeAll();
                            });

                            Pisofi.container.closest('body').on('click','.js-resume-session', Pisofi.resumeSession);
                            Pisofi.container.closest('body').on('click','.js-delete-session', Pisofi.deleteSession);
                            Pisofi.container.closest('body').on('click','.js-pause-session', Pisofi.pauseSession);
                            Pisofi.container.closest('body').on('click','.js-add-to-wallet', Pisofi.addToWallet);
                            Pisofi.container.closest('body').on('click','.js-use-wipass-code', Pisofi.useWipassHandler);
                                                            Pisofi.btnInsertCoin.on('click', Pisofi.insertCoin);
                                Pisofi.container.closest('body').on('click','.js-select-wifi', Pisofi.useWifi);
                                Pisofi.container.closest('body').on('click','.js-select-data', Pisofi.useData);
                                Pisofi.container.closest('body').on('click','.js-select-wipass', Pisofi.ticketify);
                                Pisofi.container.closest('body').on('click','.js-select-charge', Pisofi.goCharge);
                                                            Pisofi.container.closest('body').on("click", '.js-select-station-charge', Pisofi.selectChargingStationWs);
                                Pisofi.container.closest('body').on('click', '.js-select-vendo-item', Pisofi.selectInsertCoinVendo);

                                                            Pisofi.btnShowPromos.on('click', Pisofi.showEloadDialog);
                                Pisofi.container.closest('body').on('click', '.js-buy-load', Pisofi.buyLoad);
                                Pisofi.container.closest('body').on('click', '.js-buy-regular-load', Pisofi.buyRegularLoad);
                                Pisofi.container.closest('body').on('click', '.js-eload', Pisofi.showEloadDialog);
                                Pisofi.container.closest('body').on('click', '.js-show-promo-list', Pisofi.showEloadPromos);
                                Pisofi.container.closest('body').on('click', '.js-show-all-promos', Pisofi.showAllPromos);
                                Pisofi.container.closest('body').on('click', '.js-show-history', Pisofi.showEloadHistory);
                                Pisofi.container.closest('body').on('change', '#vendo', Pisofi.selectVendo);
                                Pisofi.container.closest('body').on('click', '#btn-pay-load', Pisofi.payLoad);
                                Pisofi.container.closest('body').on('click', '#btn-pay-load-wallet', Pisofi.payLoadWallet);
                                Pisofi.container.closest('body').on('click', '.js-show-order', Pisofi.showOrder);
                                Pisofi.container.closest('body').on('click', '.js-claim-refund', Pisofi.claimRefund);
                            
                            Pisofi.btnUseWiPass.on('click', Pisofi.useWiPass);
                            Pisofi.container.on('click', '.js-continue', Pisofi.continue);
                            Pisofi.container.on('click', '.js-show-rates', Pisofi.showRates);
                            Pisofi.container.on('click', '.js-toggle-sessions', Pisofi.toggleSessions);

                            
                                                        
                                                                                                                    Pisofi.container.on('click', '.js-convert-to-wipass', Pisofi.convertToWiPass);
                            
                            $(document).ajaxStart(function(){
                                Pisofi.loader.show();
                            });
                            $(document).ajaxComplete(function(){
                                Pisofi.loader.hide();
                            });
                        };


                    Pisofi.addToWallet = function() {
                                                    Pisofi.btnSignIn.trigger("click");
                                                
                    };

                    Pisofi.toggleSessions = function() {
                        var $this = $(this);

                        if (Pisofi.tblSessions.is(":visible")) {
                            $this.removeClass('fa-chevron-circle-up')
                                .addClass('fa-chevron-circle-down');
                            Pisofi.tblSessions.slideUp(200);
                        } else {

                            if (!Pisofi.sessionList) {
                                $.getJSON("/api/my-sessions")
                                    .done(function(response){
                                        Pisofi.sessionList = response.result;
                                        var params = { sessions: Pisofi.sessionList};
                                        var sessions = Pisofi.compiledTemplates.sessions(params);
                                        $("#tbl-sessions").find("tbody").html(sessions);
                                    })
                                    .fail(function(err){

                                    })
                                    .always(function(){
                                        $this.removeClass('fa-chevron-circle-down')
                                            .addClass('fa-chevron-circle-up');
                                        Pisofi.tblSessions.slideDown(200);
                                    });
                            } else {
                                $this.removeClass('fa-chevron-circle-down')
                                            .addClass('fa-chevron-circle-up');
                                        Pisofi.tblSessions.slideDown(200);
                            }

                        }
                    };

                    
                    
                        
                        
                                                
                            Pisofi.convertToWiPass = function(evt) {
                                var $this = $(this),
                                    id = $this.data('id'),
                                    time = $this.data('time');

                                                                    Pisofi.fnConvertToWiPass.call(this,evt, id, time);
                                                            };

                            Pisofi.fnConvertToWiPass = function(evt, id, time) {
                                if (time < 60) {
                                        alertify.warning("You don't have enough time to convert to WiPass. The minimum is one minute");
                                        return;
                                    }
                                    var remaining = Pisofi.fn.secondsToTime(time);

                                    var fields = [];
                                    if (remaining.days > 0) {
                                        fields.push(new Field("number","days","Days", { required: false, value: remaining.days, min:"0", max: remaining.days}).toField());
                                    }

                                    var rhours = (remaining.days * 24) + remaining.hours;
                                    if (rhours > 0) {
                                        fields.push(new Field("number","hours","Hours", { required: false, value: remaining.hours, min:"0", max: rhours }).toField());
                                    }
                                    
                                    fields.push(new Field("number","minutes","Minutes", { required: true, value: remaining.minutes, min:"0", max: (remaining.minutes + (remaining.hours * 60) + (remaining.days * 24 * 60))}).toField());


                                    var dialog = alertify.pop('Convert to WiPass',
                                        "<div class='pad js-window-convert small'></div>").show();

                                    var html = $(".js-window-convert");
                                    var form = $("<form id='frm-convert'>");
                                    html.append(form);

                                    fields.push(new Field("submit", "submit", "Save", { required: true, inline: false, formGroup:true, value: "Save", classname: "btn btn-success pull-right" }).toField());

                                    form.nosForm({
                                        fields: fields,
                                        animationSpeed: 50,
                                        validate: true,
                                        ajax: true,
                                        htmlValidation: false,
                                        honeypot: true,
                                        messageLocation: {
                                            top: false,
                                            bottom: true
                                        },
                                        submit: function (formdata, form, evt) {

                                            formdata.mac = Pisofi.mac;
                                            formdata.id = id;
                                            formdata.csrf_name = Pisofi.csrf.name;
                                            formdata.csrf_value = Pisofi.csrf.value;

                                            var totalTime = ((parseInt(formdata.days,10) * 24 * 60) || 0) + ((parseInt(formdata.hours,10) * 60) || 0) + ((parseInt(formdata.minutes,10)) || 0);

                                            if (totalTime < 1) {
                                                alertify.warning("You can only convert a minimum of one minute");
                                                return;
                                            }
                                            
                                            if (totalTime < Pisofi.minTimeWipassConversion) {
                                                alertify.warning("Please enter a minimum of " + ((Pisofi.minTimeWipassConversion * 60).toString().toHHMMSS()) + ".");
                                                return;
                                            }
                                            
                                            alertify.confirm("Confirm",
                                                "Are you sure?",
                                                function () {

                                                    $.ajax({
                                                            type: 'POST',
                                                            url: '/api/convertsessiontowipass',
                                                            dataType: 'json',
                                                            data: formdata
                                                        })
                                                        .done(function (output) {
                                                            alertify.closeAll();
                                                            Pisofi.csrf.name = output.token.csrf_name;
                                                            Pisofi.csrf.value = output.token.csrf_value;
                                                            if (output.result.status == "OK") {
                                                                alertify.success(output.result.message);
                                                                setTimeout(function(){
                                                                    window.location.reload();
                                                                }, 700);
                                                            }
                                                            else {
                                                                alertify.error(output.result.message);
                                                            }
                                                        })
                                                        .fail(function (error) {
                                                            alert(error.responseText);
                                                        });

                                                },
                                                function () { });

                                        },
                                        init: function (form) {
                                        },
                                        onlySubmitWithValue: true
                                    });
                            };

                        
                        Pisofi._handleConnection = function(connect, mac, ip, time, id, params){
                            var data = {
                                    "csrf_name" : Pisofi.csrf.name,
                                    "csrf_value" : Pisofi.csrf.value,
                                    action : connect,
                                    mac : mac,
                                    ip : ip,
                                    time: time,
                                    source: "user",
                                    params : params,
                                    id : id || (Pisofi.client ? Pisofi.client.id : null ) || null
                                }; 
                            return $.ajax({
                                url : '/api/connections',
                                type : 'POST',
                                data : data,
                                dataType : 'json'
                            }).promise();
                        };

                        Pisofi._handleSession = function(connect, id){
                            var data = {
                                    "csrf_name" : Pisofi.csrf.name,
                                    "csrf_value" : Pisofi.csrf.value,
                                    action : connect,
                                    session : id,
                                }; 
                            return $.ajax({
                                url : '/api/usersessions',
                                type : 'POST',
                                data : data,
                                dataType : 'json'
                            }).promise();
                        };


                            Pisofi.resumeSession = function(evt){
                                                                    Pisofi.fnResumeSession.call(this, evt);
                                                            };

                            Pisofi.fnResumeSession = function(evt){
                                evt.preventDefault();
                                var needsConfirmation = 0,
                                    session = $(this).data('id');

                                if (needsConfirmation) {
                                    alertify.confirm('Confirm', 'Click OK to Confirm', function(){
                                        Pisofi._handleSession("connect", session)
                                            .done(function(res){
                                                if (res.result.status == "OK") {
                                                    alertify.success(res.result.message);
                                                } else { 
                                                    alertify.warning(res.result.message);
                                                }
                                                setTimeout(function(){
                                                    window.location.reload();
                                                }, 700);
                                            })
                                            .fail(function(err){

                                            });
                                    },function(){});
                                } else {
                                    Pisofi._handleSession("connect", session)
                                            .done(function(res){
                                                if (res.result.status == "OK") {
                                                    alertify.success(res.result.message);
                                                } else { 
                                                    alertify.warning(res.result.message);
                                                }
                                                setTimeout(function(){
                                                    window.location.reload();
                                                }, 700);
                                            })
                                            .fail(function(err){

                                            });
                                }
                                
                                return false;
                            };

                            Pisofi.deleteSession = function(evt){
                                                                    Pisofi.fnDeleteSession.call(this, evt);
                                                            };

                            Pisofi.fnDeleteSession = function() {
                                var $this = $(this),
                                    id = $this.data('id'),
                                    reload = $this.data('reload');
                                Pisofi.deleteMySession(id, $this, reload);
                            };

                            Pisofi.deleteMySession = function(id, container, reload) {
                                var formdata = {};
                                formdata.csrf_name = Pisofi.csrf.name;
                                formdata.csrf_value = Pisofi.csrf.value;
                                formdata.id = id;

                                alertify.confirm("Are you sure?", function(){
                                    Pisofi.removeThisSession(formdata)
                                    .done(function(response){
                                        Pisofi.csrf.name = response.token.csrf_name;
                                        Pisofi.csrf.value = response.token.csrf_value;
                                        if (response.result.status == "OK") {
                                            alertify.success(response.result.message);
                                            setTimeout(function(){
                                                window.location.reload();
                                            }, 1000);
                                        } else {
                                            alertify.warning(response.result.message);
                                        }
                                    }) 
                                    .fail(function(err){

                                    });
                                }, function(){});
                            };

                            Pisofi.removeThisSession = function(data) {
                                return $.ajax({
                                        'type' : 'POST',
                                        'url' : "/api/usersessions/delete",
                                        dataType: 'json',
                                        data : data
                                    });
                            };

                            Pisofi.pauseSession = function(evt){
                                                                    Pisofi.fnPauseSession.call(this, evt);
                                                            };

                            Pisofi.fnPauseSession = function(evt){
                                evt.preventDefault();
                                var needsConfirmation = 0,
                                    session = $(this).data('id');

                                if (needsConfirmation) {
                                    alertify.confirm('Confirm', 'Click OK to Confirm', function(){
                                        Pisofi._handleSession("pause", session)
                                            .done(function(res){
                                                if (res.result.status == "OK") {
                                                    alertify.success(res.result.message);
                                                } else { 
                                                    alertify.warning(res.result.message);
                                                }
                                                setTimeout(function(){
                                                    window.location.reload();
                                                }, 700);
                                            })
                                            .fail(function(err){

                                            });
                                    },function(){});
                                } else {
                                    Pisofi._handleSession("pause", session)
                                            .done(function(res){
                                                if (res.result.status == "OK") {
                                                    alertify.success(res.result.message);
                                                } else { 
                                                    alertify.warning(res.result.message);
                                                }
                                                setTimeout(function(){
                                                    window.location.reload();
                                                }, 700);
                                            })
                                            .fail(function(err){

                                            });
                                }
                                
                                return false;
                            };

                        alertify.insertCoinDialog ||
                            alertify.dialog('insertCoinDialog',
                                function() {
                                    return {
                                        main: function(title, content) {
                                            this.setHeader(title);
                                            this.setContent(content);

                                        },
                                        build: function() {
                                                                                    },
                                        callback:function(closeEvent){
                                            //The closeEvent has the following properties
                                            //
                                            // index: The index of the button triggering the event.
                                            // button: The button definition object.
                                            // cancel: When set true, prevent the dialog from closing.
                                            if (confirm("Are you sure?")){
                                            } else {
                                                closeEvent.cancel = true;
                                            }
                                        },
                                        setup: function() {
                                            return {
                                                focus: {
                                                    element: function() {
                                                        return this.elements.body.querySelector(this.get('selector'));
                                                    },
                                                    select: true
                                                },
                                                buttons:[{text: "Cancel", key:27, className: "btn btn-secondary"/*Esc*/}],
                                                options: {
                                                    maximizable: false,
                                                    resizable: false,
                                                    padding: false,
                                                    movable: false,
                                                    modal: true,
                                                    closable: false,
                                                    onshow: function() {
                                                        Pisofi.getInsertCoinClientSession();
                                                        window.onbeforeunload = function(){
                                                            return 'Are you sure you want to leave?';
                                                        };
                                                    },
                                                    onclose: function() {
                                                        try {
                                                            if (Pisofi.insertCoinTimer) {
                                                                Pisofi.insertCoinTimer.stop();
                                                            }
                                                            Pisofi.stopBackgroundAudio();
                                                            if (Pisofi.insertCoinTransaction.vendo) {
                                                                Pisofi.connection.unsubscribe("oncoininserted." + Pisofi.insertCoinTransaction.vendo, Pisofi.onInsertCoinInserted);
                                                            }
                                                        } catch (ex) {}
                                                        if (Pisofi.eloadTimer) {
                                                            Pisofi.eloadTimer.stop();
                                                            Pisofi.eloadTimer = null;
                                                        }
                                                        Pisofi.insertCoinTransaction.vendo = null;
                                                        window.onbeforeunload = function(){
                                                        };
                                                    }   
                                                }
                                            };
                                        },
                                        settings: {
                                            selector: undefined
                                        }
                                    };
                                });

                            Pisofi.insertCoin = function(evt){
                                                                    Pisofi.fnInsertCoin.call(this, evt);
                                                            };

                            Pisofi.fnInsertCoin = function(evt) {
                                evt.preventDefault();
                                Pisofi.enableAudio();

                                $.getJSON("/api/vendos/active")
                                    .done(function(response){
                                        Pisofi.csrf.name = response.token.csrf_name;
                                        Pisofi.csrf.value = response.token.csrf_value;
                                        Pisofi.vendos = response.result.data;
                                        
                                        if (Pisofi.vendos.length == 0) {
                                            alertify.warning("No Vendo Available");
                                        } else if (Pisofi.vendos.length == 1) {
                                            var vendo = Pisofi.vendos.shift();
                                            Pisofi.showInsertCoinVendos(vendo);
                                        } else {
                                            var vendoSelections = Pisofi.compiledTemplates.vendoSelection(response.result.data);
                                            createAlertifyDialog("vendoSelection");
                                            alertify.vendoSelection("Vendos", vendoSelections);
                                        }
                                    })
                                    .fail(function(fail){
                                        alert("Failed to retrieve vendos");
                                    });

                                return false;
                            };

                            
                            Pisofi.getInsertCoinSession = function (){
                                Pisofi.connection.call('clientconnect.' + Pisofi.insertCoinTransaction.vendo, { vendo: Pisofi.insertCoinTransaction.vendo, clientId : "" })
                                    .then(function (result) {

                                        try {
                                            Pisofi.connection.subscribe("oncoininserted." + Pisofi.insertCoinTransaction.vendo, Pisofi.onInsertCoinInserted);
                                            Pisofi.connection.subscribe("onconnectionavailable", Pisofi.onInsertCoinConnectionAvailable);
                                        } catch (ex){

                                        }
                                        var lblEload = $(".js-insert-coin-message"),
                                            lblAmount = $("#insert-coin-coins"),
                                            paymentForm = $('.js-insert-container'),
                                            divPayment = paymentForm.find('.js-insert-body'),
                                            divPaymentDetails = paymentForm.find('.progress');
                                        Pisofi.insertCoinTransaction.subscribed = false;

                                        // call was successful
                                        if (result.status == "OK"){
                                            lblEload.removeClass('alert-danger h2').addClass('alert-info');
                                            Pisofi.timeout = result.data.time;
                                            Pisofi.insertCoinTransaction.subscribed = true;
                                            if (Pisofi.insertCoinTimer) {
                                                Pisofi.insertCoinTimer.stop();
                                            }

                                            Pisofi.insertCoinTimer = new Timer();

                                            Pisofi.insertCoinRemainingTime = Pisofi.timeout;
                                            var connectionTime = Pisofi.timeout,
                                                timeLabel = divPaymentDetails.find(".progress-bar").removeClass('bg-warning bg-danger').css('width','100%');

                                            Pisofi.insertCoinTimer.start({countdown: true, startValues: {seconds: Pisofi.timeout }});
                                            timeLabel.html(Pisofi.insertCoinTimer.toHumanReadable());
                                            var percent = ((Pisofi.insertCoinRemainingTime/connectionTime)*100);
                                            Pisofi.insertCoinTimer.addEventListener('secondsUpdated', function (e) {
                                                if (!Pisofi.insertCoinTimer) {
                                                    e.detail.timer.stop();
                                                    return;
                                                }
                                                var percent = ((Pisofi.insertCoinRemainingTime/connectionTime)*100);
                                                timeLabel.css("width",percent + "%");
                                                if (percent > 30 && percent <= 70) {
                                                    if (!timeLabel.hasClass('bg-warning')){
                                                        timeLabel.removeClass('bg-primary').addClass('bg-warning');
                                                    }
                                                }
                                                if (percent <= 30) {
                                                    if (!timeLabel.hasClass('bg-danger')){
                                                        timeLabel.removeClass('bg-warning').addClass('bg-danger');
                                                    }
                                                }
                                                Pisofi.insertCoinRemainingTime--;
                                                timeLabel.html(Pisofi.insertCoinTimer.toHumanReadable());
                                            });
                                            Pisofi.insertCoinTimer.addEventListener('targetAchieved', function (e) {
                                                Pisofi.insertCoinTimer.stop();
                                                divPayment.html("<div class='alert alert-warning border-danger font-weight-bold'>Your time is up!</div>");
                                                if (Pisofi.insertCoinTransaction.go_online_when_timeout) {
                                                    if (Pisofi.insertCoinCoins > 0){
                                                        if (Pisofi.insertCoinCoins >= Pisofi.insertCoinTransaction.min_amount_for_wifi) {
                                                            Pisofi._goOnline();
                                                        }
                                                    } else {
                                                        alertify.closeAll();
                                                    }
                                                } else {
                                                    Pisofi.showInsertCoinVendos("");
                                                }
                                            });

                                            lblEload.html(result.message);

                                            // TODO: add logic for toggling display of items in table
                                            Pisofi.insertCoinTransaction.can_convert = result.data.can_convert;
                                            Pisofi.insertCoinTransaction.can_charge = result.data.can_charge;
                                            Pisofi.insertCoinTransaction.min_amount_for_wifi = result.data.min_amount_for_wifi;
                                            Pisofi.insertCoinTransaction.min_amount_for_data = result.data.min_amount_for_data;
                                            Pisofi.insertCoinTransaction.min_amount_for_wipass = result.data.min_amount_for_wipass;
                                            Pisofi.insertCoinTransaction.ask_confirmation = result.data.ask_confirmation;
                                            Pisofi.insertCoinTransaction.allow_audio = result.data.allow_audio;
                                            Pisofi.insertCoinTransaction.show_instructions = result.data.show_instructions;
                                            Pisofi.insertCoinTransaction.go_online_when_timeout = result.data.go_online_when_timeout;
                                            Pisofi.insertCoinTransaction.time_show_goonline = result.data.time_show_goonline;
                                            Pisofi.insertCoinTransaction.max_users_reached = result.data.max_users_reached;
                                            Pisofi.insertCoinTransaction.whitelisted = result.data.whitelisted;
                                            Pisofi.insertCoinTransaction.data_enabled = result.data.data_enabled;
                                            Pisofi.insertCoinTransaction.charging_stations = result.data.charging_stations;

                                            if (Pisofi.insertCoinTransaction.allow_audio) {
                                                Pisofi.playBackgroundAudio();
                                            }

                                            if (Pisofi.insertCoinCoins > 0) {
                                                $('.js-table-items').slideDown();
                                                if (Pisofi.insertCoinTransaction.can_charge && Pisofi.insertCoinTransaction.charging_stations > 0) {
                                                    $(".js-row-charge").show();
                                                }
                                                if (Pisofi.insertCoinTransaction.can_convert && Pisofi.insertCoinCoins >= Pisofi.insertCoinTransaction.min_amount_for_wipass && !Pisofi.insertCoinTransaction.max_users_reached && !Pisofi.insertCoinTransaction.whitelisted) {
                                                    $(".js-row-wipass").show();
                                                }

                                                if (Pisofi.insertCoinCoins >= Pisofi.insertCoinTransaction.min_amount_for_wifi && !Pisofi.insertCoinTransaction.max_users_reached && !Pisofi.insertCoinTransaction.whitelisted && Pisofi.insertCoinTransaction.time_show_goonline) {
                                                    $(".js-row-wifi").show();
                                                }

                                                //console.log(Pisofi.insertCoinTransaction);

                                                if (Pisofi.insertCoinCoins >= Pisofi.insertCoinTransaction.min_amount_for_data && Pisofi.insertCoinTransaction.data_enabled && !Pisofi.insertCoinTransaction.max_users_reached && !Pisofi.insertCoinTransaction.whitelisted) {
                                                    $(".js-row-data").show();
                                                }

                                            } else {
                                                $('.js-table-items').hide();
                                            }

                                            if (Pisofi.isOnline) {
                                                $(".js-select-wifi, .js-select-data").show();
                                            } else {
                                                $(".js-select-wifi, .js-select-data").hide();
                                            }
                                            
                                            if (Pisofi.insertCoinTransaction.show_instructions) {
                                                var msg = "<div class=' alert-success p-2 m-2 small rounded'>Please insert a minimum of <span class='font-weight-bold'>" + Pisofi.insertCoinTransaction.min_amount_for_wifi + "</span> coin(s) for wifi ";
                                                if (Pisofi.insertCoinTransaction.can_convert) {
                                                    msg += "and a minimum of <span class='font-weight-bold'>" + Pisofi.insertCoinTransaction.min_amount_for_wipass + "</span> coin(s) for wipass conversion";
                                                }
                                                msg += "</div>";
                                                $(".insert-footer").html(msg);
                                            }
                                            
                                            divPaymentDetails.show();
                                            divPayment.slideDown();

                                        } else {
                                            Pisofi.insertCoinTransaction.subsribed = false;
                                            lblEload.removeClass('alert-info').removeClass('alert-info').addClass('alert-danger h2');
                                            lblEload.html(result.message);
                                            divPaymentDetails.hide();
                                            divPayment.slideDown();
                                        }
                                    },
                                    function (error) {
                                        // call failed
                                    });
                            }

                            Pisofi.onInsertCoinConnectionAvailable = function(topic, data) {
                                if (Pisofi.insertCoinTransaction.vendo && data.subtopic.toUpperCase() == Pisofi.insertCoinTransaction.vendo.toUpperCase()) {
                                                                    }
                            };

                            Pisofi.disableButtons = function() {
                                $(".js-select-wifi").attr('disabled','disabled');
                                $(".js-select-data").attr('disabled','disabled');
                                $(".js-select-charge").attr('disabled','disabled');
                                $(".js-select-wipass").attr('disabled','disabled');
                            };
                            
                            Pisofi.getInsertCoinClientSession = function() {
                                Pisofi.connection.call("clientoldsession." + Pisofi.insertCoinTransaction.vendo,{ vendo: Pisofi.insertCoinTransaction.vendo, clientId : "" })
                                .then(function (data) {
                                    //("OLD DATA", data);
                                            Pisofi.insertCoinCoins = data.amount;
                                            var insertCoin = $("#insert-coin-coins").html(data.amount.toFixed(2));
                                                insertCoin.data('amount', data.amount);
                                            $(".js-time-wifi").html(data.time_formatted);
                                            if (data.time_expiration && data.time_expiration.length > 1) {
                                                $(".js-time-wifi-expiration").html("<i class='fa fa-fw fa-hourglass-start text-danger'></i>EXP: " + data.time_expiration).css('display','block');
                                            }

                                            if (data.data_limit_formatted) {
                                                $(".js-time-data").html(data.data_limit_formatted);
                                            }

                                            if (data.data_expiration && data.data_expiration.length > 1) {
                                                $(".js-time-data-expiration").html("<i class='fa fa-fw fa-hourglass-start text-danger'></i>EXP: " + data.data_expiration).css('display','block');
                                            }

                                            $(".js-time-wipass").html(data.time_formatted);
                                            $(".js-time-charge").html(data.charge_time_formatted);
                                        },
                                        function (error) {
                                            // call failed
                                        });
                            }
                            Pisofi.enableAudio = function() {
                                try {
                                    Pisofi.insertPlayer.currentTime = 0;
                                    Pisofi.insertPlayer.play();
                                    Pisofi.insertPlayer.pause();
                                    Pisofi.coinInsertPlayer.currentTime = 0;
                                    Pisofi.coinInsertPlayer.play();
                                    Pisofi.coinInsertPlayer.pause();
                                    Pisofi.successDing.currentTime = 0;
                                    Pisofi.successDing.play();
                                    Pisofi.successDing.pause();
                                } catch (ex) {
                                }
                            }

                            Pisofi.selectInsertCoinVendo = function() {
                                var $this = $(this),
                                    vendo = $this.data('address');

                                Pisofi.enableAudio();

                                var coinslot = Pisofi.vendos.filter(function(slot) { return slot.address == vendo; });
                                if (coinslot.length) {
                                    Pisofi.showInsertCoinVendos(coinslot.shift());
                                } else {
                                    alertify.warning("Vendo could not be found");
                                }
                            };

                            Pisofi.showInsertCoinVendos = function(coinslot) {
                                var vendo = coinslot ? coinslot.address : "";

                                Pisofi.stopBackgroundAudio();
                                if (vendo.trim().length > 0 ) {
                                    
                                    var html = Pisofi.compiledTemplates.insertCoin({
                                        vendo : coinslot
                                    });
                                    alertify.insertCoinDialog("Insert Coin", html);

                                    if (!Pisofi.isOnline){
                                        $(".insert-message").html("<div class='p-1 small text-danger alert alert-warning bg-warning' style='font-weight: bold;'><i class='fa fa-spinner fa-spin fa-fw'></i> No Internet Connection</span></div>");
                                    }
                                    var insertCointainer = $(".js-insert-cointainer");
                                    divPayment = insertCointainer.find('.js-insert-body');
                                    divPayment.slideUp();
                                    
                                    if (Pisofi.insertCoinTransaction.vendo && Pisofi.insertCoinTransaction.subscribed) {
                                        try {
                                            Pisofi.connection.unsubscribe("oncoininserted." + Pisofi.insertCoinTransaction.vendo, Pisofi.onInsertCoinInserted);
                                        } catch (ex) {}
                                        if (Pisofi.insertCoinTimer) {
                                            Pisofi.insertCoinTimer.stop();
                                            Pisofi.insertCoinTimer = null;
                                        }
                                        Pisofi.insertCoinTransaction.vendo = null;
                                    }

                                    Pisofi.insertCoinTransaction.vendo = vendo;
                                    Pisofi.getInsertCoinSession();
                                } else {
                                    if (Pisofi.insertCoinTransaction.vendo && Pisofi.insertCoinTransaction.subscribed) {
                                        try {
                                            Pisofi.connection.unsubscribe("oncoininserted." + Pisofi.insertCoinTransaction.vendo, Pisofi.onInsertCoinInserted);
                                        } catch (ex) {}
                                        if (Pisofi.insertCoinTimer) {
                                            Pisofi.insertCoinTimer.stop();
                                            Pisofi.insertCoinTimer = null;
                                        }
                                    }
                                    Pisofi.insertCoinTransaction.vendo = null;
                                    Pisofi.insertCoinTransaction.subscribed = false;
                                }
                            }

                            Pisofi.onInsertCoinInserted = function(topic,data){
                                if (Pisofi.ip == data.ip){
                                    Pisofi.insertCoinCoins = data.amount;
                                    $('.js-table-items').slideDown();
                                    $("#insert-coin-coins").html(parseFloat(data.amount).toFixed(2));
                                    $('.js-insert-body').find(".progress-bar").removeClass('bg-warning bg-danger');

                                    if (Pisofi.insertCoinCoins > 0) {
                                        $(".js-select-wifi").attr('disabled','disabled');
                                        $(".js-select-data").attr('disabled','disabled');
                                        $(".js-select-charge").attr('disabled','disabled');
                                        $(".js-select-wipass").attr('disabled','disabled');

                                        clearTimeout(Pisofi.insertedCoinEvent);

                                        Pisofi.insertedCoinEvent = setTimeout(function(){
                                            if (Pisofi.insertCoinTransaction.can_charge && Pisofi.insertCoinTransaction.charging_stations > 0) {
                                                $(".js-time-charge").html(data.charge_time_formatted);
                                                $(".js-row-charge").fadeIn();
                                                $(".js-select-charge").removeAttr('disabled');
                                            }
                                            if (Pisofi.insertCoinTransaction.can_convert && Pisofi.insertCoinCoins >= Pisofi.insertCoinTransaction.min_amount_for_wipass && !Pisofi.insertCoinTransaction.whitelisted) {
                                                $(".js-time-wipass").html(data.time_formatted);
                                                $(".js-row-wipass").fadeIn();
                                                $(".js-select-wipass").removeAttr('disabled');
                                            }

                                            if (Pisofi.insertCoinCoins >= Pisofi.insertCoinTransaction.min_amount_for_wifi && !Pisofi.insertCoinTransaction.whitelisted && Pisofi.insertCoinTransaction.time_show_goonline) {
                                                $(".js-time-wifi").html(data.time_formatted);
                                                $(".js-row-wifi").fadeIn();
                                                $(".js-select-wifi").removeAttr('disabled');

                                                if (data.time_expiration && data.time_expiration.length > 1) {
                                                    $(".js-time-wifi-expiration").html("<i class='fa fa-fw fa-hourglass-start text-danger'></i>EXP: " + data.time_expiration).css('display','block');
                                                } else {
                                                    $(".js-time-wifi-expiration").hide();
                                                }
                                                
                                            }

                                            if (Pisofi.insertCoinCoins >= Pisofi.insertCoinTransaction.min_amount_for_data && !Pisofi.insertCoinTransaction.whitelisted) {
                                                if (data.data_limit_formatted) {
                                                    $(".js-time-data").html(data.data_limit_formatted);
                                                    $(".js-row-data").fadeIn();
                                                    $(".js-select-data").removeAttr('disabled');

                                                    if (data.data_expiration && data.data_expiration.length > 1) {
                                                        $(".js-time-data-expiration").html("<i class='fa fa-fw fa-hourglass-start text-danger'></i>EXP: " + data.data_expiration).css('display','block');
                                                    } else {
                                                        $(".js-time-data-expiration").hide();
                                                    }
                                                } else {
                                                    $(".js-row-data").hide();
                                                    $(".js-time-data-expiration").hide();
                                                }
                                            }
                                        }, 700);

                                    } else {
                                        $('.js-table-items').hide();
                                    }
                                    
                                    Pisofi.insertCoinRemainingTime = Pisofi.timeout;
                                    Pisofi.insertCoinTimer.reset();
                                    if (Pisofi.insertCoinTransaction.allow_audio) {
                                        Pisofi.playInsertCoin();
                                    }
                                    alertify.success("COIN INSERTED").dismissOthers();
                                }
                            };

                            Pisofi.useWifi = function(evt){
                                evt.preventDefault();
                                var needsConfirmation = Pisofi.insertCoinTransaction.ask_confirmation;

                                if (Pisofi.insertCoinCoins <= 0 ) return;

                                if (needsConfirmation) {
                                    alertify.confirm('Confirm', 'Click OK to Confirm', function(){
                                        Pisofi._goOnline();
                                    },function(){});
                                } else {
                                    Pisofi._goOnline();
                                }
                                
                                return false;
                            };

                            Pisofi.useData = function(evt){
                                evt.preventDefault();
                                var needsConfirmation = Pisofi.insertCoinTransaction.ask_confirmation;

                                if (Pisofi.insertCoinCoins <= 0 ) return;

                                if (needsConfirmation) {
                                    alertify.confirm('Confirm', 'Click OK to Confirm', function(){
                                        Pisofi._goData();
                                    },function(){});
                                } else {
                                    Pisofi._goData();
                                }
                                
                                return false;
                            };

                            Pisofi._goOnline = function() {
                                Pisofi.disableButtons();
                                Pisofi.loader.show();
                                Pisofi.connection.call('goonline.' + Pisofi.insertCoinTransaction.vendo, { vendo: Pisofi.insertCoinTransaction.vendo, clientId : "" })
                                    .then(function (result) {
                                        Pisofi.loader.hide();
                                        Pisofi.countdown = null;
                                        if (result.status == "OK"){
                                            if (Pisofi.insertCoinTransaction.allow_audio) {
                                                Pisofi.playSuccessDing();
                                            }
                                            alertify.closeAll();
                                            alertify.success(result.message);
                                            setTimeout(function(){
                                                //window.location = "http://portal.pisofi.com";
                                                                                                    window.location.reload();
                                                                                            }, 500);
                                        } else {
                                            alertify.error(result.message);
                                        }
                                    },
                                    function (error) {
                                        // call failed
                                        Pisofi.loader.hide();
                                    });
                            };

                            Pisofi._goData = function() {
                                Pisofi.disableButtons();
                                Pisofi.loader.show();
                                Pisofi.connection.call('godata.' + Pisofi.insertCoinTransaction.vendo, { vendo: Pisofi.insertCoinTransaction.vendo, clientId : "" })
                                    .then(function (result) {
                                        Pisofi.loader.hide();
                                        Pisofi.countdown = null;
                                        if (result.status == "OK"){
                                            if (Pisofi.insertCoinTransaction.allow_audio) {
                                                Pisofi.playSuccessDing();
                                            }
                                            alertify.closeAll();
                                            alertify.success(result.message);
                                            setTimeout(function(){
                                                //window.location = "http://portal.pisofi.com";
                                                                                                    window.location.reload();
                                                                                            }, 500);
                                        } else {
                                            alertify.error(result.message);
                                        }
                                    },
                                    function (error) {
                                        // call failed
                                        Pisofi.loader.hide();
                                    });
                            };

                            Pisofi.ticketify = function(evt) {
                                if (Pisofi.insertCoinCoins <= 0 ) return;
                                alertify.confirm('Confirm', 'Click OK to Confirm', 
                                    function(){
                                        Pisofi.disableButtons();
                                        Pisofi.connection.call('converttowipass.' + Pisofi.insertCoinTransaction.vendo, { client_id : "", vendo : Pisofi.insertCoinTransaction.vendo } )
                                            .then(function (result) {
                                                    if (result.status == "OK") {
                                                        if (Pisofi.insertCoinTransaction.allow_audio) {
                                                            Pisofi.playSuccessDing();
                                                        }
                                                        alertify.closeAll();
                                                        alertify.success("Successful Wipass Conversion");
                                                        setTimeout(function(){
                                                            window.location = "/wipass";
                                                        }, 600);
                                                    } else {
                                                        alertify.error(result.message);
                                                    }
                                                },
                                                function (error) {
                                                    // call failed
                                                });

                                    }
                                    , function(){ });
                                return false;
                            };

                            Pisofi.goCharge = function(evt){
                                evt.preventDefault();
                                if (Pisofi.insertCoinCoins <= 0) return;

                                $.getJSON("/api/chargesession", {
                                    "csrf_name" : Pisofi.csrf.name,
                                    "csrf_value" : Pisofi.csrf.value
                                }, function(data){
                                    Pisofi.csrf.name = data.token.csrf_name;
                                    Pisofi.csrf.value = data.token.csrf_value;
                                    if (data.result.client) {
                                        var pinName = data.result.client.pin_name;
                                        alertify.confirm('Confirm', 'Click OK to Confirm', function(){
                                            Pisofi.disableButtons();
                                            Pisofi.loader.show();
                                            Pisofi.connection.call('gocharge.' + Pisofi.insertCoinTransaction.vendo, { vendo: Pisofi.insertCoinTransaction.vendo, station : pinName, clientId : "" })
                                                .then(function (result) {
                                                        Pisofi.loader.hide();
                                                        alertify.closeAll();
                                                        Pisofi.countdown = null;
                                                        var data = {
                                                            "csrf_name" : Pisofi.csrf.name,
                                                            "csrf_value" : Pisofi.csrf.value,
                                                            station_id : pinName
                                                        }; 
                                                        if (result.status == "OK"){
                                                                    
                                                            if (Pisofi.insertCoinTransaction.allow_audio) {
                                                                Pisofi.playSuccessDing();
                                                            }
                                                            alertify.success(result.message);
                                                            setTimeout(function(){
                                                                //window.location = "http://portal.pisofi.com";
                                                                window.location = "/";
                                                            }, 700);
                                                            
                                                        } else {
                                                            alertify.error(result.message);
                                                        }
                                                    },
                                                    function (error) {
                                                        // call failed
                                                    });
                                        },function(){});
                                    }
                                    else {
                                        $.getJSON("/api/chargingstations",{
                                            "csrf_name" : Pisofi.csrf.name,
                                            "csrf_value" : Pisofi.csrf.value,
                                            'vendo' : Pisofi.insertCoinTransaction.vendo
                                        }, function(data){
                                            Pisofi.csrf.name = data.token.csrf_name;
                                            Pisofi.csrf.value = data.token.csrf_value;
                                            if (data.result.data.length > 0) {

                                                var html = "<div class='p-3 small'><h5>Please select a Charging Station</h5></div><table class='table table-bordered'><tbody>";
                                                data.result.data.forEach(function(station){
                                                    if (station.remaining_time == "AVAILABLE") {
                                                        html+= "<tr><td>" + station.station + "</td><td><button class='btn btn-block btn-sm bg-success js-select-station-charge' data-station='"+station.station_id+"'>SELECT</button></td></li>";
                                                    }
                                                });
                                                html += "</ul>";
                                            } else {
                                                var html = "<div class='alert alert-warning small pad'>No Available Charging Stations</div>";
                                            }
                                            alertify.pop("Charging Stations", html);
                                        });
                                    }
                                });

                                return false;
                            };

                            Pisofi.selectChargingStationWs = function() {
                                var $this = $(this),
                                    stationId = $this.data('station'),
                                    vendo = Pisofi.insertCoinTransaction.vendo;

                                    var data = {
                                        "csrf_name" : Pisofi.csrf.name,
                                        "csrf_value" : Pisofi.csrf.value,
                                        station_id : stationId,
                                        vendo :     Pisofi.insertCoinTransaction.vendo
                                    }; 

                                alertify.confirm('Confirm', 'Click OK to Confirm', function(){
                                    Pisofi.loader.show();
                                    alertify.closeAll();
                                    Pisofi.connection.call('gocharge.' + vendo, { vendo: vendo, station : stationId, clientId : "" })
                                        .then(function (result) {
                                                Pisofi.loader.hide();
                                                Pisofi.countdown = null;
                                                    if (result.status == "OK"){
                                                        if (Pisofi.insertCoinTransaction.allow_audio) {
                                                            Pisofi.playSuccessDing();
                                                        }
                                                            alertify.success(result.message);
                                                            setTimeout(function(){
                                                                //window.location = "http://portal.pisofi.com";
                                                                window.location = "/";
                                                            }, 700);
                                                    } else {
                                                        alertify.error(result.message);
                                                    }
                                                },
                                                function (error) {
                                                    // call failed
                                                });
                                },function(){});
                            
                            };

                            Pisofi.chargeClient = function(data) {
                                $.ajax({
                                    type: 'POST',
                                    url: '/api/stationcharge',
                                    dataType: 'json',
                                    data: data
                                })
                                .done(function (output) {
                                    Pisofi.csrf.name = output.token.csrf_name;
                                    Pisofi.csrf.value = output.token.csrf_value;
                                    if (output.result.status == "OK") {
                                        alertify.closeAll();
                                        alertify.success(output.result.message);
                                        setTimeout(function(){
                                            //window.location = "http://portal.pisofi.com";
                                            window.location = "/";
                                        }, 700);
                                    }
                                    else {
                                        if (output.result.fields) {
                                            var fields = output.result.fields;
                                            var message = [];
                                            for (var k in fields) {
                                                message.push(fields[k]);
                                            }
                                            alertify.warning("<li>" + message.join("</li><li>") + "</li>");
                                        }
                                        else {
                                            alertify.error(output.result.message);
                                        }
                                    }
                                })
                                .fail(function (error) {
                                    alert(error.responseText);
                                });
                            };

                            



                        Pisofi.playInsertCoin = Pisofi.fn.throttle(function(){
                            Pisofi.coinInsertPlayer.currentTime = 0;
                            if (Pisofi.insertCoinTransaction.allow_audio) {
                                Pisofi.coinInsertPlayer.play();   
                            } else {
                                Pisofi.coinInsertPlayer.pause();
                            }
                            
                        }, 600);

                        Pisofi.playSuccessDing = function() {
                            
                            if (Pisofi.insertCoinTransaction.allow_audio) {
                                Pisofi.successDing.play();
                            } else {
                                Pisofi.successDing.pause();
                            }
                        };

                        Pisofi.playBackgroundAudio = function() {
                            
                            if (Pisofi.insertPlayer.paused) {
                                Pisofi.insertPlayer.loop = true;
                                Pisofi.currentTime = 0;
                            }
                            if (Pisofi.insertCoinTransaction.allow_audio) {
                                Pisofi.insertPlayer.play();
                            } else {
                                Pisofi.insertPlayer.pause();
                            }
                        };
                        Pisofi.stopBackgroundAudio = function() {
                            if (Pisofi.insertPlayer.paused) {
                            } else {
                                Pisofi.insertPlayer.pause();
                            }
                        };

                        Pisofi.surePlayAudio = function() {
                            Pisofi.insertCoinTransaction.allow_audio = true;
                            Pisofi.playBackgroundAudio();
                        }
                        
                        Pisofi.showRates = function() {
                            $.getJSON("/api/rates",{
                                "csrf_name" : Pisofi.csrf.name,
                                "csrf_value" : Pisofi.csrf.value
                            }, function(data){
                                Pisofi.csrf.name = data.token.csrf_name;
                                Pisofi.csrf.value = data.token.csrf_value;
                                var html = Pisofi.compiledTemplates.rates(data.result);
                                alertify.pop("<strong>RATES</strong>", html);
                            });
                        };

                                                
                        Pisofi.useWiPass = function(evt){
                                                            Pisofi.fnUseWiPass.call(this, evt);
                                                    };

                        Pisofi.fnUseWiPass = function(evt){
                            evt.preventDefault();

                            var dialog = alertify.pop('Use Wipass',
                                "<div class='p-3 js-window-use-wipass'></div>").show();

                            var html = $(".js-window-use-wipass");
                            html.append("<div class='form-row'><div class='col-sm-12 col-md-8 mt-1'><input id='wipass-code' autofocus type='text' placeholder='Wipass code' class='form-control text-center font-weight-bold text-uppercase' /></div><div class='col-sm-12 col-md-4 mt-1'><button class='btn btn-block btn-primary js-use-wipass-code'><i class='fa fa-ticket'></i> Use</button></div>");
                            html.append("<div id='wipass-list'></div>");
                            Pisofi.getWipassList().done(function(response) {

                                if (response.length) {
                                    var list = "";
                                    list += "<p class='mt-3'>Or select from your wipass list:</p>";
                                    list += "<table class='table table-condensed table-striped table-sm mt-3'><thead><tr><th>Code</th><th>Type</th><th>Time/Data</th><th>Action</th></tr></thead><tbody>";

                                    list += response.map(function(w){ return "<tr><td>"+w.code+"</td><td>"+w.type+"<td>"+w.time+"</td></td><td><button class='btn btn-success btn-sm js-use-wipass-code' data-code='"+w.code+"'><i class='fa fa-fw fa-ticket'></i> Use</button></td></tr>"; }).join("");
                                    
                                    list += "</tbody></table>";
                                    $("#wipass-list").html(list).fadeIn();
                                }
                            });
                            setTimeout(function(){
                                $("#wipass-code").focus();
                            }, 1000);
                            return false;
                        };

                        Pisofi.getWipassList = function() {
                            var d = $.Deferred();
                            if (Pisofi.wipassList) {
                                d.resolve(Pisofi.wipassList);
                            } else {
                                $.getJSON("/wipass")
                                    .done(function(response) {
                                        Pisofi.csrf.name = response.token.csrf_name;
                                        Pisofi.csrf.value = response.token.csrf_value;
                                        Pisofi.wipassList = response.result;
                                        d.resolve(response.result);
                                    })
                                    .fail(function(){
                                        d.reject();
                                    });
                            }
                            return d.promise();
                        };

                        Pisofi.useWipassHandler = function(evt){
                            evt.preventDefault();
                            var ticket = $(this).data('code');
                            if (!ticket) {
                                ticket = $("#wipass-code").val();
                            }
                            if (ticket) {
                                return Pisofi.fnUseWipassTicket(ticket);
                            }
                        };

                        Pisofi.fnUseWipassTicket = function(ticket){
                            var data = {
                                "csrf_name" : Pisofi.csrf.name,
                                "csrf_value" : Pisofi.csrf.value,
                                code: ticket,
                                mac : Pisofi.mac
                            }; 

                            Pisofi._checkWiPass(ticket)
                                .done(function(result){
                                    Pisofi.csrf.name = result.token.csrf_name;
                                    Pisofi.csrf.value = result.token.csrf_value;
                                    if (result.result.status != "OK") {
                                        if (result.result.fields) {
                                            var fields = result.result.fields;
                                            var message = [];
                                            for (var k in fields) {
                                                message.push(fields[k]);
                                            }
                                            alertify.warning("<li>" + message.join("</li><li>") + "</li>");
                                        }
                                        else {
                                            alertify.error(result.result.message);
                                        }
                                        return;
                                    }
                                    var res = result.result;
                                    if (res.hasCode) {
                                        alertify.prompt( 'WiPass', 'Enter the Key Code', "", 
                                            function(evt, sharecode) { 
                                                Pisofi.useTicket(ticket, sharecode);
                                            }, 
                                            function() { 
                                            });
                                    }
                                    else {
                                        Pisofi.useTicket(ticket);
                                    }

                                }).fail(function(err){
                                    alert(err.responseText);
                                });
                            return false;
                        };

                        Pisofi.useTicket = function(code, sharecode){
                            var data = {
                                    "csrf_name" : Pisofi.csrf.name,
                                    "csrf_value" : Pisofi.csrf.value,
                                    code : code,
                                    sharecode: sharecode,
                                    mac : Pisofi.mac
                                };

                            $.ajax({
                                url : "/api/usewipass",
                                type : "POST",
                                data : data,
                                dataType : "json"
                            }).done(function(result){
                                result = result.result;
                                if (result.status == "OK"){
                                    if (result.code == 103) {
                                        alertify.success(result.message);
                                        setTimeout(function(){
                                            window.location.reload();
                                        },700);
                                    } else if (result.code == 101) {
                                        Pisofi._handleConnection("extend", Pisofi.mac, Pisofi.ip, parseInt(result.time,10), null, result.params ? result.params : null)
                                            .done(function(data){
                                                alertify.success(data.result.message);
                                                setTimeout(function(){
                                                    window.location.reload();
                                                },700);
                                            })
                                            .fail(function(err){
                                            });
                                    } else {
                                        alertify.success(result.message);
                                        setTimeout(function(){
                                            window.location.reload();
                                        },700);
                                    }
                                }
                                else {
                                    if (result.fields) {
                                        var fields = result.fields;
                                        var message = [];
                                        for (var k in fields) {
                                            message.push(fields[k]);
                                        }
                                        alertify.warning("<li>" + message.join("</li><li>") + "</li>");
                                    }
                                    else {
                                        alertify.error(result.message);
                                    }
                                }
                            }).fail(function(err){
                            });
                            
                        };
                        Pisofi._getWiPass = function(code) {
                            var data = {
                                "csrf_name" : Pisofi.csrf.name,
                                "csrf_value" : Pisofi.csrf.value,
                                code: code,
                            }; 
                            return $.ajax({
                                    url : '/api/getwipass',
                                    type : 'GET',
                                    data : data,
                                    dataType : 'json'
                                });
                        };

                        Pisofi._checkWiPass = function(code) {
                            var data = {
                                "csrf_name" : Pisofi.csrf.name,
                                "csrf_value" : Pisofi.csrf.value,
                                code: code,
                            }; 
                            return $.ajax({
                                    url : '/api/checkwipass',
                                    type : 'GET',
                                    data : data,
                                    dataType : 'json'
                                });
                        };

                        Pisofi.continue = function(evt){
                                                            Pisofi.fnContinue.call(this, evt);
                                                    };

                        Pisofi.fnContinue = function(evt){
                            evt.preventDefault();
                            Pisofi._handleConnection("reconnect", Pisofi.mac, Pisofi.ip, 0)
                                    .done(function(data){
                                        alertify.success(data.result.message);
                                        setTimeout(function(){
                                            window.location.reload();
                                        }, 700);
                                    })
                                    .fail(function(err){
                                    });
                            return false;
                        };

                        Pisofi.setCookie = function(cname, cvalue, exdays) {
                            var d = new Date();
                            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 700));
                            var expires = "expires="+d.toUTCString();
                            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
                        };

                        Pisofi.getCookie = function(cname){
                            var name = cname + "=";
                            var ca = document.cookie.split(';');
                            for(var i = 0; i < ca.length; i++) {
                                var c = ca[i];
                                while (c.charAt(0) == ' ') {
                                c = c.substring(1);
                                }
                                if (c.indexOf(name) == 0) {
                                return c.substring(name.length, c.length);
                                }
                            }
                            return "";
                        };

                        Pisofi.checkCookie = function() {
                            var repeaterMode = Pisofi.getCookie("repeater_mode");
                            if (repeaterMode != "") {
                            } else {
                                alertify.pop("NOTICE","<div class='pad'><span class='text-danger'>Account sign in is required.</span><br><br>To proceed with any transaction, you will be required to sign in your user account.<br><br>This will prevent any data loss and provide more convenient access to your credits.<br><br>This will also allow you to transfer your connecton to and from main vendo's main hotspot and repeater(s) without losing your data.<br><br><button class='btn btn-secondary js-hide-repeater'>Don't show this again.</button></div>");
                            }
                        }

                    return { init: Pisofi.init };
                })($, Timer, Handlebars, Pisofi);

                pfi.init({
                    container : $(".main-content"),
                    csrf : {
                        name : $("#csrf_name").val(),
                        value : $("#csrf_value").val()
                    },
                    mac : $("#mac").val(),
                    ip : $("#ip").val(),
                    remaining : parseInt($("#remaining").val(),10) || 0,
                    connectionTime : parseInt($("#connection_time").val(),10) || 0,
                    client : {"id":471,"mac":"DC:F5:05:07:5E:59","ip_address":"10.0.18.79","date_connected":"2021-06-07 14:28:44","connection_time":10500,"remaining_time":5610,"running_time":"10500.00","remarks":"Connected","mark":12,"download_rate":"3000.00","upload_rate":"3000.00","upload_auto":1,"download_auto":1,"auto_manage":1,"status":1,"created_at":"2021-06-07 14:28:44","updated_at":"2021-06-07 15:50:12","sent":0,"client_id":null,"data":"{\"subscriber_id\":\"cb87920d82a1c646c402dc8b2425751a\"}","notified":0,"session_id":471,"allow_pause":1,"allow_conversion":1,"allow_sharing":0,"expiration_date":null,"pause_count":0,"admin_pause_override":0,"download_usage":"814862216.00","upload_usage":"517911357.00","type":1,"bandwidth_limit":"0.00","last_paused":null},
                    templates : {
                        sessions : $("#tpl-sessions").html(),
                        rates : $("#tpl-rates").html(),
                        chargingRates : $("#tpl-rates-charging").html(),
                        promos : $("#tpl-promos").html(),
                        order : $("#tpl-order").html(),
                        promo: $("#tpl-promo").html(),
                        eload: $("#tpl-eload").html(),
                        vendoOptions: $("#tpl-vendos-option").html(),
                        history: $("#tpl-history").html(),
                        insertCoin : $("#tpl-insert-coin").html(),
                        vendoSelection : $("#tpl-vendo-selection").html(),
                    }
                });
                    
            
                }); 
            </script></main></body></html>